BEGIN
FOR HDR IN(SELECT DISTINCT DOCUMENTNO FROM IM_EFORM_UPR  WHERE PERIOD = '122017'
AND AVAILABLE  IN('Y','YY')-- AND EXPIRYDATE > To_Date('31/12/2017','DD/MM/RRRR')  
AND GROSSUPR > 0) LOOP

INSERT INTO IM_UPR_MEMBERS  
SELECT MEMBERPOLICYCODE,PFPDETAILCODE,POLICYFINANCEPOSTINGCODE FROM IM_POLICYFINANCEPOSTINGDTL WHERE POLICYFINANCEPOSTINGCODE IN
(SELECT REF_CODE FROM IM_NGI_JVPOSTING WHERE REF_NO IN
(SELECT DOCUMENTNO FROM IM_EFORM_UPR  WHERE PERIOD = '122017'
AND AVAILABLE  IN('Y','YY')-- AND EXPIRYDATE > To_Date('31/12/2017','DD/MM/RRRR')  
AND GROSSUPR > 0));
COMMIT;

END LOOP;
END;

         
INSERT INTO IM_UPR_MEMBERS
SELECT    U.*,D.MEMBERPOLICYCODE  FROM IM_EFORM_UPR U
JOIN IM_NGI_JVPOSTING J ON J.REF_NO = U.DOCUMENTNO 
JOIN IM_POLICYFINANCEPOSTINGDTL D ON D.POLICYFINANCEPOSTINGCODE = J.REF_CODE
LEFT JOIN IM_MEMBERPOLICY M ON M.MEMBERPOLICYCODE = D.MEMBERPOLICYCODE  
WHERE  J.JVPREMIUMTYPE=0 AND U.PERIOD = '122017'
AND U.AVAILABLE  IN('Y','YY')-- AND EXPIRYDATE > To_Date('31/12/2017','DD/MM/RRRR')  
AND U.GROSSUPR > 0    AND M.ACARDID = U.ACARDID AND U.ACARDID IS NOT  NULL      


SELECT * FROM IM_EFORM_UPR  WHERE  PERIOD = '122017'
AND AVAILABLE  IN('Y','YY')-- AND EXPIRYDATE > To_Date('31/12/2017','DD/MM/RRRR')  
AND GROSSUPR > 0 AND ACARDID IS   NULL

               

               --167940 168281

CREATE TABLE IM_UPR_MEMBERS AS SELECT H.*,1 MEMBERPOLICYCODE FROM IM_EFORM_UPR H WHERE ROWNUM < 2
TRUNCATE TABLE IM_UPR_MEMBERS
 

                                                  


                   SELECT DISTINCT I.PRIMKEY FROM  IM_UPR_MEMBERS I




SELECT * FROM IM_EFORM_UPR WHERE PRIMKEY NOT IN
(SELECT PRIMKEY FROM IM_UPR_MEMBERS) AND  PERIOD = '122017'
AND AVAILABLE  IN('Y','YY')-- AND EXPIRYDATE > To_Date('31/12/2017','DD/MM/RRRR')  
AND GROSSUPR > 0  AND policyid = '0250-03'





UPDATE  IM_EFORM_UPR SET AVAILABLE = 'D' WHERE PRIMKEY NOT IN
(SELECT PRIMKEY FROM IM_UPR_MEMBERS) AND  PERIOD = '122017'
AND AVAILABLE  IN('Y','YY')-- AND EXPIRYDATE > To_Date('31/12/2017','DD/MM/RRRR')  
AND GROSSUPR > 0  AND policyid = '0250-03'