DECLARE L_POLICYCODE NUMBER;
BEGIN
FOR HDR IN(SELECT * FROM IM_EFORM_CLAIMS_HDR WHERE To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND  To_Date('30/11/2018','DD/MM/RRRR')
AND Upper(POLICYTYPE) = 'GROUP' ) LOOP

SELECT Max(POLICYCODE) INTO L_POLICYCODE FROM IM_POLICY WHERE POLICYID = HDR.POLICYID
AND  AUTHORIZEDSTATUS = 4 AND To_Date(STARTDATE,'DD/MM/RRRR') > To_Date('01/01/2015','DD/MM/RRRR')
AND OWNERCODE <> 0;

UPDATE  IM_EFORM_CLAIMS_HDR SET POLICYCODE = L_POLICYCODE,iSUPDATE=30 WHERE  CLAIMLINE = HDR.CLAIMLINE;
COMMIT;

END LOOP;
END;


DECLARE L_POLICYCODE NUMBER;
BEGIN
FOR HDR IN(SELECT * FROM IM_EFORM_CLAIMS_HDR WHERE To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND  To_Date('30/11/2018','DD/MM/RRRR')
AND Upper(POLICYTYPE) = 'INDIVIDUAL') LOOP

SELECT Max(INDIVIDUALPOLICYCODE) INTO L_POLICYCODE FROM IM_INDIVIDUALPOLICY WHERE POLICYID = HDR.POLICYID
AND  AUTHORIZEDSTATUS = 1 AND To_Date(STARTDATE,'DD/MM/RRRR') > To_Date('01/01/2015','DD/MM/RRRR')
AND OWNERCODE <> 0;

UPDATE  IM_EFORM_CLAIMS_HDR SET POLICYCODE = L_POLICYCODE,ISUPDATE=30 WHERE  CLAIMLINE = HDR.CLAIMLINE;
COMMIT;

END LOOP;
END;


BEGIN
FOR H IN(SELECT * FROM(SELECT H.BENEFICARYCARDNUMBER,M.APOLICYID,H.POLICYID,MANAGEDBY,CONSTANTNAME,
To_Char(M.POLICYSTARTDDATE,'RRRR') UWYEAR FROM IM_EFORM_CLAIMS_HDR H
JOIN IM_MEMBERPOLICY M ON M.ACARDID=H.BENEFICARYCARDNUMBER
LEFT JOIN IM_POLICY P ON P.POLICYCODE=M.POLICYCODE   AND M.TYPEE=1
LEFT JOIN IM_INDIVIDUALPOLICY IP ON IP.INDIVIDUALPOLICYCODE=M.POLICYCODE AND M.TYPEE=2
LEFT JOIN GENCONSTANT G ON G.CATEGORY='NGIQUOTATIONTYPE' AND G.LANGUAGECODE='en-US' AND G.CONSTANTVALUE=Nvl(P.OWNERCODE,IP.OWNERCODE)
WHERE  CLAIMTYPE <> 'TPA CLAIM' AND To_Date(PAYMENTDATE,'DD/MM/RRRR') BETWEEN To_Date('01/01/2018','DD/MM/RRRR')
AND  To_Date('30/11/2018','DD/MM/RRRR') AND Upper(MANAGEDBY)<>Upper(CONSTANTNAME)) WHERE Upper(MANAGEDBY) NOT LIKE '%NEXTCARE%') LOOP

UPDATE IM_EFORM_CLAIMS_HDR SET MANAGEDBY=H.CONSTANTNAME,POLICYID=H.APOLICYID,UWYEAR=H.UWYEAR 
WHERE BENEFICARYCARDNUMBER=H.BENEFICARYCARDNUMBER;
COMMIT;
END LOOP;
END;

  

INSERT INTO IM_RI_SESSION_CLAIM_HDR
SELECT DISTINCT TRT.TREATYNAME,DOCUMENTNO,To_Date(A.PAYMENTDATE,'DD/MM/RRRR') DOCUMENTNAME,INS.INS_NAME,TDTL.FACULTATIVEPERCENTAGE,
NULL,P.POLICYID,P.POLICYNAME,0 TOTALPREMIUM,(NETVALUE)*(TDTL.FACULTATIVEPERCENTAGE/100) CLAIMAMOUNT,A.UWYEAR,
NETVALUE DOCUMENTAMOUNT,0 NETPREMIUM,1 COMMISSION,DTL.FACULTATIVEPERCENTAGE TREATYPERCENTAGE,G.CONSTANTNAME,
A.MANAGEDBY,A.CLAIMNUMBER,To_Date(REPORTEDDATE,'DD/MM/RRRR'),To_Date(TREATMENTDATE,'DD/MM/RRRR'),
CLAIMTYPE,'PROCESSED',NULL,A.MAINBRANCH,P.STARTDATE,P.ENDDATE,ROWNUM AS CLINE
 FROM IM_EFORM_CLAIMS_HDR A,IM_POLICY P,IM_POLICY_INSURER_DTL DTL,IM_POLICY_INSURER_SUBDTL SDTL,
IM_TREATY_HDR TRT,IM_TREATY_DTL TDTL,GENCONSTANT G,IM_INSURER INS 
WHERE To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND To_Date('30/11/2018','DD/MM/RRRR')  
AND Upper(POLICYTYPE) = 'GROUP' AND A.POLICYID = P.POLICYID   AND P.POLICYCODE = DTL.POLICYCODE
AND A.POLICYCODE = P.POLICYCODE 
AND DTL.POLICYINSURERDTLCODE = SDTL.POLICYINSURERDTLCODE  AND SDTL.TREATYHDRCODE = TRT.TREATYHDRCODE 
AND G.CATEGORY='PREMIUMTYPES' AND G.LANGUAGECODE = 'en-US' AND G.CONSTANTVALUE = SDTL.PREMIUMTYPE
AND TRT.TREATYHDRCODE = TDTL.TREATYHDRCODE AND P.OWNERCODE   IN(11,14,15,22,23,20) AND INS.INSCODE = TDTL.INSURERCODE 
AND SDTL.PREMIUMTYPE = 1     


INSERT INTO IM_RI_SESSION_CLAIM_HDR
SELECT DISTINCT TRT.TREATYNAME,DOCUMENTNO,To_Date(A.PAYMENTDATE,'DD/MM/RRRR') DOCUMENTNAME,INS.INS_NAME,TDTL.FACULTATIVEPERCENTAGE,
NULL,P.POLICYID,P.POLICYNAME,0 TOTALPREMIUM,(NETVALUE)*(TDTL.FACULTATIVEPERCENTAGE/100) CLAIMAMOUNT,A.UWYEAR,
NETVALUE DOCUMENTAMOUNT,0 NETPREMIUM,1 COMMISSION,DTL.FACULTATIVEPERCENTAGE TREATYPERCENTAGE,G.CONSTANTNAME,
A.MANAGEDBY,A.CLAIMNUMBER,To_Date(REPORTEDDATE,'DD/MM/RRRR'),To_Date(TREATMENTDATE,'DD/MM/RRRR'),
CLAIMTYPE,'PROCESSED',NULL,A.MAINBRANCH,P.STARTDATE,P.ENDDATE,ROWNUM AS CLINE
 FROM IM_EFORM_CLAIMS_HDR A,IM_POLICY P,IM_POLICY_INSURER_DTL DTL,IM_POLICY_INSURER_SUBDTL SDTL,
IM_TREATY_HDR TRT,IM_TREATY_DTL TDTL,GENCONSTANT G,IM_INSURER INS 
WHERE To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND To_Date('30/11/2018','DD/MM/RRRR')  
AND Upper(POLICYTYPE) = 'GROUP' AND A.POLICYID = P.POLICYID   AND P.POLICYCODE = DTL.POLICYCODE
AND A.POLICYCODE = P.POLICYCODE 
AND DTL.POLICYINSURERDTLCODE = SDTL.POLICYINSURERDTLCODE  AND SDTL.TREATYHDRCODE = TRT.TREATYHDRCODE 
AND G.CATEGORY='PREMIUMTYPES' AND G.LANGUAGECODE = 'en-US' AND G.CONSTANTVALUE = SDTL.PREMIUMTYPE
AND TRT.TREATYHDRCODE = TDTL.TREATYHDRCODE AND P.OWNERCODE  NOT IN(11,14,15,22,23) AND INS.INSCODE = TDTL.INSURERCODE 
AND SDTL.PREMIUMTYPE = 4 AND A.POLICYID='3888-19' 


SELECT * FROM(SELECT Sum(AAMT) AAMT,Sum(BAMT) BAMT,DOCUMENTNO FROM(SELECT 0 AAMT,Sum(CLAIMAMOUNT) BAMT,To_Char(DOCUMENTNO) DOCUMENTNO FROM IM_RI_SESSION_CLAIM_HDR
GROUP BY DOCUMENTNO
UNION
SELECT  Sum(NETVALUE) AAMT,0 BAMT,DOCUMENTNO FROM IM_EFORM_CLAIMS_HDR WHERE  To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND  To_Date('30/11/2018','DD/MM/RRRR') AND Upper(POLICYTYPE)='GROUP'
GROUP BY DOCUMENTNO   
) GROUP BY DOCUMENTNO ) WHERE AAMT <> BAMT





 
SELECT * FROM(SELECT Sum(AAMT) AAMT,Sum(BAMT) BAMT,POLICYID FROM(SELECT 0 AAMT,Sum(CLAIMAMOUNT) BAMT,
To_Char(POLICYID) POLICYID FROM IM_RI_SESSION_CLAIM_HDR
WHERE DOCUMENTNO IN(SELECT DOCUMENTNO FROM(SELECT Sum(AAMT) AAMT,Sum(BAMT) BAMT,DOCUMENTNO FROM(SELECT 0 AAMT,Sum(CLAIMAMOUNT) BAMT,To_Char(DOCUMENTNO) DOCUMENTNO FROM IM_RI_SESSION_CLAIM_HDR
GROUP BY DOCUMENTNO
UNION
SELECT  Sum(NETVALUE) AAMT,0 BAMT,DOCUMENTNO FROM IM_EFORM_CLAIMS_HDR WHERE  To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND  To_Date('30/11/2018','DD/MM/RRRR') AND Upper(POLICYTYPE)='GROUP'
GROUP BY DOCUMENTNO   
) GROUP BY DOCUMENTNO ) WHERE AAMT <> BAMT) GROUP BY POLICYID
UNION
SELECT  Sum(NETVALUE) AAMT,0 BAMT,To_Char(POLICYID) POLICYID FROM IM_EFORM_CLAIMS_HDR WHERE  To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND  To_Date('30/11/2018','DD/MM/RRRR') AND Upper(POLICYTYPE)='GROUP'
AND DOCUMENTNO IN(SELECT DOCUMENTNO FROM(SELECT Sum(AAMT) AAMT,Sum(BAMT) BAMT,DOCUMENTNO FROM(SELECT 0 AAMT,Sum(CLAIMAMOUNT) BAMT,To_Char(DOCUMENTNO) DOCUMENTNO FROM IM_RI_SESSION_CLAIM_HDR
GROUP BY DOCUMENTNO
UNION
SELECT  Sum(NETVALUE) AAMT,0 BAMT,DOCUMENTNO FROM IM_EFORM_CLAIMS_HDR WHERE  To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND  To_Date('30/11/2018','DD/MM/RRRR') AND Upper(POLICYTYPE)='GROUP'
GROUP BY DOCUMENTNO   
) GROUP BY DOCUMENTNO ) WHERE AAMT <> BAMT)
GROUP BY POLICYID   
) GROUP BY POLICYID ) WHERE AAMT <> BAMT


SELECT * FROM IM_POLICY WHERE POLICYID IN
('3888-19','7035-1','7190-1','7331-1')


SELECT * FROM IM_EFORM_CLAIMS_HDR WHERE POLICYID='3888-19'  AND   To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND  To_Date('30/11/2018','DD/MM/RRRR') 

SELECT * FROM IM_CLAIM_PROCESS_HEADER WHERE ACR_FORM_NO IN
(   
SELECT CLAIMNUMBER FROM IM_EFORM_CLAIMS_HDR WHERE POLICYID='3888-19'  AND   To_Date(PAYMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND  To_Date('30/11/2018','DD/MM/RRRR') 
)

SELECT * FROM GENCONSTANT WHERE CATEGORY ='NGIQUOTATIONTYPE'
 
