SELECT * FROM  IM_NGI_JVPOSTING WHERE REF_CODE  IN(
SELECT   DISTINCT REF_CODE FROM IM_NGI_JVPOSTING WHERE REF_CODE IN(
SELECT REF_CODE FROM(SELECT SUM(AMT1) A1,SUM(AMT2) A2,REF_CODE FROM(
SELECT  SUM(DECODE(MEMOTYPE,0,ABS(AMOUNT),ABS(AMOUNT)*-1)) AMT1,0 AMT2,REF_CODE 
FROM IM_NGI_JVPOSTING A WHERE TO_DATE(REFDATE,'DD/MM/RRRR') BETWEEN TO_DATE('01/05/2017','DD/MM/RRRR')
AND  TO_DATE('31/05/2017','DD/MM/RRRR') AND REF_CODE IS   NOT NULL AND JVPREMIUMTYPE <> 0   
GROUP BY REF_CODE 
UNION ALL
SELECT SUM(AMT1) AMT1,SUM(AMT2) AMT2,REF_CODE FROM(
SELECT 0 AMT1,(AGENTCOM+TPAFEE+ADMINFEE) AMT2,
(SELECT   REF_CODE FROM IM_NGI_JVPOSTING J  WHERE  J.REF_NO = H.ENDORESMENTID) REF_CODE
FROM IM_EFORM_UW_HDR H 
WHERE TO_DATE(ENDORESMENTDATE,'DD/MM/RRRR') BETWEEN TO_DATE('01/05/2017','DD/MM/RRRR')
AND  TO_DATE('31/05/2017','DD/MM/RRRR'))   
GROUP BY REF_CODE)   GROUP BY REF_CODE) WHERE ABS(A1+A2) > 5
)) AND POLICYCODE IS NOT NULL AND OTHERCOMMISIONCODE IS NULL  



SELECT POLICYID INTO L_POLICYID FROM IM_POLICY WHERE POLICYCODE = HDR.POLICYCODE; 
DELETE FROM IM_EF;
COMMIT;
INSERT INTO IM_EF SELECT *  FROM IM_EFORM_UW_HDR WHERE POLICYNUMBER = L_POLICYCID AND ROWNUM < 2;
COMMIT;
UPDATE IM_EF SET BENEFICIARYFIRSTNAME = 'ADJUST COMMISSION',ADDPREMIUM = 0,OPPREMIUM = 0,
IPPREMIUM = 0,REFUNDPREMIUM = 0,TOTALPREMIUM = 0,AGENTCOM = Decode(HDR.MEMOTYPE,0,Abs(HDR.AMOUNT),Abs(AMOUNT)*-1),
ADMINFEE = 0,TPAFEE = 0,ENDORESMENTID = HDR.REF_NO,ENDORESMENTDATE = To_Date(HDR.REFDATE,'DD/MM/RRRR'),
ENDORESMENTISSUEDATE = To_Date(HDR.REFDATE,'DD/MM/RRRR');
COMMIT;
INSERT INTO IM_EFORM_UW_HDR SELECT * FROM IM_EF;
COMMIT;  


DELETE FROM IM_EFORM_UW_HDR  WHERE BENEFICIARYFIRSTNAME='ADJUST COMMISSION'
AND AGENTCOM='770.09'


SELECT * FROM IM_TPAPRODUCTION_HDR ORDER BY TPAPRODHDRCODE DESC