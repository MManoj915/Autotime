DECLARE L_CNNO NVARCHAR2(100);
L_CNDATE DATE;L_DNNO NVARCHAR2(100);
L_DNDATE DATE;L_COUNT NUMBER;
BEGIN
FOR HDR IN(
SELECT POS.POLICYFINANCEPOSTINGCODE,DTL.PFPDETAILCODE,MPOL.MEMBERPOLICYCODE,
MPOL.MEMBERCODE,MPOL.REINSMEMBERCODE,POS.POLICYTYPECODE,POS.POLICYCODE,
MPOL.ACARDID,MPOL.MEMBERSTARTDATE,MPOL.MEMBERENDDATE,DTL.ADDPREMIUM,DTL.REFUNDPREMIUM,POS.FINANCENO,
POL.STARTDATE,POL.ENDDATE,POS.TOTAL,POS.DELETEPREMIUMTOTAL,POS.ADDPREMIUMTOTAL FROM IM_POLICYFINANCEPOSTINGDTL DTL
JOIN IM_POLICYFINANCEPOSTING POS ON POS.POLICYFINANCEPOSTINGCODE = DTL.POLICYFINANCEPOSTINGCODE 
JOIN IM_MEMBERPOLICY MPOL ON MPOL.MEMBERPOLICYCODE = DTL.MEMBERPOLICYCODE
LEFT JOIN IM_INDIVIDUALPOLICY POL ON POL.INDIVIDUALPOLICYCODE =POS.INDIVIDUALPOLICYCODE AND POLICYTYPECODE=2
WHERE To_Date('01/01/2018','DD/MM/RRRR') BETWEEN To_Date(POL.STARTDATE,'DD/MM/RRRR') AND To_Date(POL.ENDDATE,'DD/MM/RRRR')
AND DTL.ADDPREMIUM <> 0) LOOP

IF (HDR.ADDPREMIUMTOTAL-HDR.DELETEPREMIUMTOTAL) > 0 THEN 
SELECT Min(REF_NO),Min(REFDATE) INTO L_DNNO,L_DNDATE FROM IM_NGI_JVPOSTING
WHERE REF_CODE = HDR.POLICYFINANCEPOSTINGCODE AND JVPREMIUMTYPE = 0 AND MEMOTYPE = 1;
END IF;
IF (HDR.ADDPREMIUMTOTAL-HDR.DELETEPREMIUMTOTAL) < 0 THEN
SELECT Min(REF_NO),Min(REFDATE) INTO L_DNNO,L_DNDATE FROM IM_NGI_JVPOSTING
WHERE REF_CODE = HDR.POLICYFINANCEPOSTINGCODE AND JVPREMIUMTYPE = 0 AND MEMOTYPE = 0;
END IF;

IF Nvl(L_DNNO,0) = 0 THEN
SELECT Min(REF_NO),Min(REFDATE) INTO L_DNNO,L_DNDATE FROM IM_NGI_JVPOSTING
WHERE REF_CODE = HDR.POLICYFINANCEPOSTINGCODE AND JVPREMIUMTYPE = 0;
END IF;

INSERT INTO IM_POLICYFINANCE_VAT SELECT HDR.POLICYFINANCEPOSTINGCODE,HDR.PFPDETAILCODE,
HDR.MEMBERPOLICYCODE,HDR.MEMBERCODE,HDR.REINSMEMBERCODE,HDR.POLICYTYPECODE,HDR.POLICYCODE,
HDR.ACARDID,L_DNNO,L_DNDATE,NULL,NULL,1,HDR.MEMBERSTARTDATE,NULL,HDR.STARTDATE,HDR.ENDDATE,NULL,HDR.ADDPREMIUM,0,0,0,
HDR.FINANCENO FROM DUAL;
COMMIT;

END LOOP; 

FOR HDR IN(
SELECT POS.POLICYFINANCEPOSTINGCODE,DTL.PFPDETAILCODE,MPOL.MEMBERPOLICYCODE,
MPOL.MEMBERCODE,MPOL.REINSMEMBERCODE,POS.POLICYTYPECODE,POS.POLICYCODE,
MPOL.ACARDID,MPOL.MEMBERSTARTDATE,MPOL.MEMBERENDDATE,DTL.ADDPREMIUM,DTL.REFUNDPREMIUM,POS.FINANCENO,
POL.STARTDATE,POL.ENDDATE,POS.TOTAL,POS.DELETEPREMIUMTOTAL,POS.ADDPREMIUMTOTAL FROM IM_POLICYFINANCEPOSTINGDTL DTL
JOIN IM_POLICYFINANCEPOSTING POS ON POS.POLICYFINANCEPOSTINGCODE = DTL.POLICYFINANCEPOSTINGCODE 
JOIN IM_MEMBERPOLICY MPOL ON MPOL.MEMBERPOLICYCODE = DTL.MEMBERPOLICYCODE
LEFT JOIN IM_INDIVIDUALPOLICY POL ON POL.INDIVIDUALPOLICYCODE =POS.INDIVIDUALPOLICYCODE AND POLICYTYPECODE=2
WHERE To_Date('01/01/2018','DD/MM/RRRR') BETWEEN To_Date(POL.STARTDATE,'DD/MM/RRRR') AND To_Date(POL.ENDDATE,'DD/MM/RRRR') 
AND DTL.REFUNDPREMIUM <> 0) LOOP

IF (HDR.ADDPREMIUMTOTAL-HDR.DELETEPREMIUMTOTAL) > 0 THEN
SELECT Min(REF_NO),Min(REFDATE) INTO L_CNNO,L_CNDATE FROM IM_NGI_JVPOSTING
WHERE REF_CODE = HDR.POLICYFINANCEPOSTINGCODE AND JVPREMIUMTYPE = 0 AND MEMOTYPE = 1;
END IF;
IF (HDR.ADDPREMIUMTOTAL-HDR.DELETEPREMIUMTOTAL) < 0  THEN
SELECT Min(REF_NO),Min(REFDATE) INTO L_CNNO,L_CNDATE FROM IM_NGI_JVPOSTING
WHERE REF_CODE = HDR.POLICYFINANCEPOSTINGCODE AND JVPREMIUMTYPE = 0 AND MEMOTYPE = 0;
END IF;

IF Nvl(L_CNNO,0) = 0 THEN
SELECT Min(REF_NO),Min(REFDATE) INTO L_CNNO,L_CNDATE FROM IM_NGI_JVPOSTING
WHERE REF_CODE = HDR.POLICYFINANCEPOSTINGCODE AND JVPREMIUMTYPE = 0;
END IF;
                      

INSERT INTO IM_POLICYFINANCE_VAT SELECT HDR.POLICYFINANCEPOSTINGCODE,HDR.PFPDETAILCODE,
HDR.MEMBERPOLICYCODE,HDR.MEMBERCODE,HDR.REINSMEMBERCODE,HDR.POLICYTYPECODE,HDR.POLICYCODE,
HDR.ACARDID,NULL,NULL,L_CNNO,L_CNDATE,1,NULL,HDR.MEMBERENDDATE,HDR.STARTDATE,HDR.ENDDATE,NULL,0,0,HDR.REFUNDPREMIUM,0,
HDR.FINANCENO FROM DUAL;
COMMIT;

END LOOP;  
                       
END;