BEGIN
FOR HDR IN(SELECT * FROM IM_TREATY_HDR WHERE TREATYNAME IN
(SELECT DISTINCT TREATYNAME FROM IM_RI_SESSION_UW_HDR WHERE To_Date(DOCUMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2019','DD/MM/RRRR') AND To_Date('31/01/2019','DD/MM/RRRR') )
) LOOP

IF HDR.COMMISSION = 'Y' AND HDR.NGIFEE = 'Y' THEN
UPDATE IM_RI_SESSION_UW_HDR SET NETAMOUNT = TOTALPREMIUM+NGIFEE+COMMISSION WHERE TREATYNAME = HDR.TREATYNAME
AND  To_Date(DOCUMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2019','DD/MM/RRRR') AND To_Date('31/01/2019','DD/MM/RRRR') ;
END IF;

IF HDR.COMMISSION = 'N' AND HDR.NGIFEE = 'Y' THEN
UPDATE IM_RI_SESSION_UW_HDR SET NETAMOUNT = TOTALPREMIUM+NGIFEE WHERE TREATYNAME = HDR.TREATYNAME
AND  To_Date(DOCUMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2019','DD/MM/RRRR') AND To_Date('31/01/2019','DD/MM/RRRR'); 
END IF;


IF HDR.COMMISSION = 'N' AND HDR.NGIFEE = 'N' THEN 
UPDATE IM_RI_SESSION_UW_HDR SET NETAMOUNT = TOTALPREMIUM WHERE TREATYNAME = HDR.TREATYNAME
AND  To_Date(DOCUMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2019','DD/MM/RRRR') AND To_Date('31/01/2019','DD/MM/RRRR') ;
END IF;

END LOOP;
END;







                                            
BEGIN
FOR HDR IN(SELECT DISTINCT MANAGEDBY FROM IM_RI_SESSION_UW_HDR) LOOP
INSERT INTO  IM_RI_MAP
SELECT DISTINCT INS_NAME,MANAGEDBY,UWYEAR,TREATYNAME,'PRM' FROM  IM_RI_SESSION_UW_HDR WHERE MANAGEDBY = HDR.MANAGEDBY;
COMMIT;

END LOOP;
END;



INSERT INTO IM_RI_SESSION_UW_HDR
SELECT H.*,Round((TOTALPREMIUM*(NGI_FEES/100)),2) NGIFEE FROM(SELECT DISTINCT TRT.TREATYNAME,ENDORESMENTID,To_Date(A.ENDORESMENTDATE,'DD/MM/RRRR') DOCUMENTNAME,INS.INS_NAME,TDTL.FACULTATIVEPERCENTAGE,
A.ACC_PIN,P.POLICYID,P.POLICYNAME,Sum(TOTALPREMIUM)*(TDTL.FACULTATIVEPERCENTAGE/100) TOTALPREMIUM,0 CLAIMAMOUNT,A.UWYEAR,
Sum(TOTALPREMIUM) DOCUMENTAMOUNT,0 NETPREMIUM,Round((Sum(AGENTCOM+A.TPAFEE+ADMINFEE)*(TDTL.FACULTATIVEPERCENTAGE/100)),2) COMMISSION,DTL.FACULTATIVEPERCENTAGE TREATYPERCENTAGE,G.CONSTANTNAME,
A.MANAGEDBY,A.BRANCHNAME,P.STARTDATE,P.ENDDATE,P.NGI_FEES 
 FROM ICA A,IM_POLICY P,IM_POLICY_INSURER_DTL DTL,IM_POLICY_INSURER_SUBDTL SDTL,
IM_TREATY_HDR TRT,IM_TREATY_DTL TDTL,GENCONSTANT G,IM_INSURER INS 
WHERE To_Date(ENDORESMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND To_Date('31/12/2018','DD/MM/RRRR')  
AND Upper(POLICYTYPE) = 'GROUP' AND A.POLICYNUMBER = P.POLICYID   AND P.POLICYCODE = DTL.POLICYCODE   
AND P.POLICYCODE = A.POLICYCODE
AND DTL.POLICYINSURERDTLCODE = SDTL.POLICYINSURERDTLCODE  AND SDTL.TREATYHDRCODE = TRT.TREATYHDRCODE 
AND G.CATEGORY='PREMIUMTYPES' AND G.LANGUAGECODE = 'en-US' AND G.CONSTANTVALUE = SDTL.PREMIUMTYPE
AND TRT.TREATYHDRCODE = TDTL.TREATYHDRCODE AND P.OWNERCODE NOT IN(11,14,15,22,23) AND INS.INSCODE = TDTL.INSURERCODE 
AND SDTL.PREMIUMTYPE = 4     --AND ENDORESMENTID='02181123561'
GROUP BY POLICYNUMBER,ENDORESMENTID,TRT.TREATYNAME,INS.INS_NAME,TDTL.FACULTATIVEPERCENTAGE,G.CONSTANTNAME,
TRT.CALCULATIONTYPE,SDTL.PREMIUMTYPE,To_Date(A.ENDORESMENTDATE,'DD/MM/RRRR'),A.ACC_PIN,P.POLICYID,P.POLICYNAME,A.UWYEAR,
A.MANAGEDBY,A.BRANCHNAME,DTL.FACULTATIVEPERCENTAGE,P.STARTDATE,P.ENDDATE,P.NGI_FEES )H ;               


INSERT INTO IM_RI_SESSION_UW_HDR
SELECT H.*,Round((TOTALPREMIUM*(NGI_FEES/100)),2) NGIFEE FROM(SELECT DISTINCT TRT.TREATYNAME,ENDORESMENTID,To_Date(A.ENDORESMENTDATE,'DD/MM/RRRR') DOCUMENTNAME,INS.INS_NAME,TDTL.FACULTATIVEPERCENTAGE,
A.ACC_PIN,P.POLICYID,P.POLICYNAME,Sum(TOTALPREMIUM)*(TDTL.FACULTATIVEPERCENTAGE/100) TOTALPREMIUM,0 CLAIMAMOUNT,A.UWYEAR,
Sum(TOTALPREMIUM) DOCUMENTAMOUNT,0 NETPREMIUM,Round((Sum(AGENTCOM+A.TPAFEE+ADMINFEE)*(TDTL.FACULTATIVEPERCENTAGE/100)),2) COMMISSION,DTL.FACULTATIVEPERCENTAGE TREATYPERCENTAGE,G.CONSTANTNAME,
A.MANAGEDBY,A.BRANCHNAME,P.STARTDATE,P.ENDDATE,P.NGI_FEES 
 FROM ICA A,IM_INDIVIDUALPOLICY P,IM_POLICY_INSURER_DTL DTL,IM_POLICY_INSURER_SUBDTL SDTL,
IM_TREATY_HDR TRT,IM_TREATY_DTL TDTL,GENCONSTANT G,IM_INSURER INS 
WHERE To_Date(ENDORESMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND To_Date('31/12/2018','DD/MM/RRRR')  
AND Upper(POLICYTYPE) = 'INDIVIDUAL' AND A.POLICYNUMBER = P.POLICYID   AND P.INDIVIDUALPOLICYCODE = DTL.INDIVIDUALPOLICYCODE   
AND P.INDIVIDUALPOLICYCODE = A.POLICYCODE
AND DTL.POLICYINSURERDTLCODE = SDTL.POLICYINSURERDTLCODE  AND SDTL.TREATYHDRCODE = TRT.TREATYHDRCODE 
AND G.CATEGORY='PREMIUMTYPES' AND G.LANGUAGECODE = 'en-US' AND G.CONSTANTVALUE = SDTL.PREMIUMTYPE
AND TRT.TREATYHDRCODE = TDTL.TREATYHDRCODE AND P.OWNERCODE NOT IN(11,14,15,22,23) AND INS.INSCODE = TDTL.INSURERCODE 
AND SDTL.PREMIUMTYPE = 4     --AND ENDORESMENTID='02181123561'
GROUP BY POLICYNUMBER,ENDORESMENTID,TRT.TREATYNAME,INS.INS_NAME,TDTL.FACULTATIVEPERCENTAGE,G.CONSTANTNAME,
TRT.CALCULATIONTYPE,SDTL.PREMIUMTYPE,To_Date(A.ENDORESMENTDATE,'DD/MM/RRRR'),A.ACC_PIN,P.POLICYID,P.POLICYNAME,A.UWYEAR,
A.MANAGEDBY,A.BRANCHNAME,DTL.FACULTATIVEPERCENTAGE,P.STARTDATE,P.ENDDATE,P.NGI_FEES)H ;


SELECT * FROM (SELECT Sum(AMT1) AMT1,Sum(AMT2) AMT2,DOCUMENTNO FROM(SELECT Sum(TOTALPREMIUM) AMT1,0 AMT2,To_Char(ENDORESMENTID) DOCUMENTNO FROM IM_EFORM_UW_HDR
WHERE To_Date(ENDORESMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND To_Date('31/12/2018','DD/MM/RRRR') AND
MANAGEDBY   NOT IN('FMC-XOL','FMC-EBP','FMC-Enhanced','Neuron-Aster','FMC Fronting') GROUP BY   To_Char(ENDORESMENTID)
UNION ALL
SELECT 0 AMT1,Sum(TOTALPREMIUM) AMT2,To_Char(DOCUMENTNO) DOCUMENTNO FROM IM_RI_SESSION_UW_HDR
WHERE To_Date(DOCUMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND To_Date('31/12/2018','DD/MM/RRRR') GROUP BY   To_Char(DOCUMENTNO)
) GROUP BY DOCUMENTNO) WHERE AMT1 <> AMT2 ;

                   



SELECT Sum(COMMISSION),MANAGEDBY FROM IM_RI_SESSION_UW_HDR GROUP BY MANAGEDBY ORDER BY MANAGEDBY;


SELECT * FROM IM_POLICY_INSURER_SUBDTL WHERE  POLICYINSURERDTLCODE IN(
SELECT POLICYINSURERDTLCODE FROM IM_POLICY_INSURER_DTL WHERE POLICYCODE IN(SELECT POLICYCODE FROM IM_EFORM_UW_HDR WHERE ENDORESMENTID IN
(SELECT DOCUMENTNO FROM IM_RI_sESSION_UW_HDR WHERE TREATYNAME='Hanover Re 2018 (White Collar)'
AND MANAGEDBY = 'NEXTCARE'      AND UWYEAR = 2018) AND POLICYTYPE='GROUP'));


SELECT * FROM IM_POLICY_INSURER_SUBDTL WHERE  POLICYINSURERDTLCODE IN(
SELECT POLICYINSURERDTLCODE FROM IM_POLICY_INSURER_DTL WHERE INDIVIDUALPOLICYCODE IN(SELECT POLICYCODE FROM IM_EFORM_UW_HDR WHERE ENDORESMENTID IN
(SELECT DOCUMENTNO FROM IM_RI_sESSION_UW_HDR WHERE TREATYNAME='Hanover Re 2018 (White Collar)'
AND MANAGEDBY = 'NEXTCARE'      AND UWYEAR = 2018) AND POLICYTYPE='INDIVIDUAL')) ;




UPDATE IM_POLICY_INSURER_SUBDTL SET TREATYHDRCODE=100000000000000212   WHERE  POLICYINSURERDTLCODE IN(
SELECT POLICYINSURERDTLCODE FROM IM_POLICY_INSURER_DTL WHERE INDIVIDUALPOLICYCODE IN(SELECT POLICYCODE FROM IM_EFORM_UW_HDR WHERE ENDORESMENTID IN
(SELECT DOCUMENTNO FROM IM_RI_sESSION_UW_HDR WHERE TREATYNAME='Hanover Re 2018 (White Collar)'
AND MANAGEDBY = 'NEXTCARE'      AND UWYEAR = 2018) AND POLICYTYPE='INDIVIDUAL'))


UPDATE IM_POLICY_INSURER_SUBDTL SET TREATYHDRCODE=100000000000000212   WHERE  POLICYINSURERDTLCODE IN(
SELECT POLICYINSURERDTLCODE FROM IM_POLICY_INSURER_DTL WHERE POLICYCODE IN(SELECT POLICYCODE FROM IM_EFORM_UW_HDR WHERE ENDORESMENTID IN
(SELECT DOCUMENTNO FROM IM_RI_sESSION_UW_HDR WHERE TREATYNAME='Hanover Re 2018 (White Collar)'
AND MANAGEDBY = 'NEXTCARE'      AND UWYEAR = 2018) AND POLICYTYPE='GROUP'))




(SELECT * FROM IM_EFORM_UW_HDR WHERE ENDORESMENTID IN
(SELECT DOCUMENTNO FROM IM_RI_sESSION_UW_HDR WHERE TREATYNAME='Hanover Re 2018 (White Collar)'
AND MANAGEDBY = 'NEXTCARE-NEXTCARE'      AND UWYEAR = 2018) AND POLICYTYPE='GROUP')



SELECT TREATYNAME,TREATYHDRCODE FROM IM_TREATY_HDR WHERE UPPER(TREATYNAME) LIKE '%AWC-ALLIANZ WHITE  COLAR -2018'

                                                   