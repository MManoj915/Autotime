CREATE OR REPLACE FUNCTION fn_policyfinanceposting
 (
  ATypeCode number default 1,
  APolicyCode  number default 100000000000000139,
  ATPASource NUMBER DEFAULT 1,
  ATPAProductionCode NUMBER DEFAULT 1
)
RETURN POLICYFINANCEPOSTINGTABLE PIPELINED IS
TABLEDATA POLICYFINANCEPOSTINGTYPE := POLICYFINANCEPOSTINGTYPE
(
 NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
);
TYPE LCURTYPE IS REF CURSOR;
LCUR LCURTYPE;

BEGIN

OPEN LCUR FOR

select * from
(Select MEM.CARDID,MEM.MEMBER_ID,
(MEM.FIRST_NAME||''||MEM.LAST_NAME) MemberName,
mem.EFFECTIVE_START_DATE  StartDate,
MEM.EFFECTIVE_END_DATE EndDate
,(select nvl(SUM(decode(nvl(MemP.FINANCEPOSTDONEFORADDITION,1),0,PREMIUM_VALUE,0)),0)  AddPremium from IM_MEMBERPOLICYPREMIUMDTL where MEMBERPOLICYCODE=MEMP.MEMBERPOLICYCODE )  AddPremium,
(select nvl(SUM(decode(nvl(MemP.FINANCEPOSTDONEFORDELETION,1),0,PREMIUM_VALUE,0)),0) DeletePremium from IM_MEMPOLICYREFUNDPREMDTL where MEMBERPOLICYCODE=MEMP.MEMBERPOLICYCODE ) DeletePremium,
MEMP.TYPEE,MEMP.POLICYCODE,MEMP.MEMBERPOLICYCODE,Cat.Category_Name,
nvl(Mem.PARENTGROUPCODE,Mem.GROUP_CODE) GroupCode
FROM im_memberpolicy memP
  join im_memberS mem on MEMP.MEMBERCODE=MEM.MEMBER_CODE
 left  join im_categories  Cat on Cat.CATEGORY_CODE=MEMP.CATEGORYCODE
 where MEMP.TYPEE=ATypeCode and  MEMP.POLICYCODE=APolicyCode
 AND Nvl(ATPASource,0) = 0
 and (nvl(FINANCEPOSTDONEFORADDITION,1)+nvl(FINANCEPOSTDONEFORDELETION,1))<>2 -- and (memP.FINANCEPOSTDONEFORADDITION is not null or (select count(*) from IM_MEMPOLICYREFUNDPREMDTL DTL where memP.MEMBERPOLICYCODE=DTL.MEMBERPOLICYCODE)>0)-- or memP.FINANCEPOSTDONEFORDELETION is not null
 ) Pol
 where    (AddPremium+DeletePremium)<>0
 UNION
 select * from
(Select Nvl(MEM.CARDID,MEM.CARDNO),MEM.MEMBER_ID,
(MEM.FIRST_NAME||''||MEM.LAST_NAME) MemberName,
mem.EFFECTIVE_START_DATE  StartDate,
MEM.EFFECTIVE_END_DATE EndDate
,(select nvl(SUM(decode(nvl(MemP.FINANCEPOSTDONEFORADDITION,1),0,PREMIUM_VALUE,0)),0)  AddPremium from IM_MEMBERPOLICYPREMIUMDTL where MEMBERPOLICYCODE=MEMP.MEMBERPOLICYCODE )  AddPremium,
(select nvl(SUM(decode(nvl(MemP.FINANCEPOSTDONEFORDELETION,1),0,PREMIUM_VALUE,0)),0) DeletePremium from IM_MEMPOLICYREFUNDPREMDTL where MEMBERPOLICYCODE=MEMP.MEMBERPOLICYCODE ) DeletePremium,
MEMP.TYPEE,MEMP.POLICYCODE,MEMP.MEMBERPOLICYCODE,Cat.Category_Name,
nvl(Mem.PARENTGROUPCODE,Mem.GROUP_CODE) GroupCode
FROM im_memberpolicy memP
  join im_reins_memberS mem on MEMP.REINSMEMBERCODE=MEM.MEMBER_CODE
 left  join im_categories  Cat on Cat.CATEGORY_CODE=MEM.CATEGORY_CODE
 where MEMP.TYPEE=ATypeCode and  MEMP.POLICYCODE=APolicyCode
 AND (REINSADDMEMBERPOLICY IN (
SELECT REINSADDMEMBERDETCODE FROM IM_REINSADDMEMBERDET WHERE REINSADDMEMBERPOLICYCODE
IN(SELECT REINSADDMEMBERPOLICYCODE FROM IM_REINS_ADDMEMBERPOLICY WHERE  Nvl(STATUS,0) = 0 AND SOURCETYPE = ATPASource
AND  NEXTCAREPRODHDRCODE = Decode(Nvl(ATPAProductionCode,0),0,NEXTCAREPRODHDRCODE,ATPAProductionCode))
UNION ALL
SELECT REINSADDMEMBERDETCODE FROM IM_REINSADDMEMBERDET WHERE REINSADDMEMBERPOLICYCODE
IN(SELECT REINSADDMEMBERPOLICYCODE FROM IM_REINS_ADDMEMBERPOLICY WHERE Nvl(STATUS,0) = 0 AND SOURCETYPE = ATPASource AND TPAPRODHDRCODE = Decode(Nvl(ATPAProductionCode,0),0,TPAPRODHDRCODE,ATPAProductionCode))) OR
REINSDELMEMBERPOLICY IN (
SELECT REINSADDMEMBERDETCODE FROM IM_REINSADDMEMBERDET WHERE REINSADDMEMBERPOLICYCODE
IN(SELECT REINSADDMEMBERPOLICYCODE FROM IM_REINS_ADDMEMBERPOLICY WHERE  Nvl(STATUS,0) = 0 AND SOURCETYPE = ATPASource AND NEXTCAREPRODHDRCODE = Decode(Nvl(ATPAProductionCode,0),0,NEXTCAREPRODHDRCODE,ATPAProductionCode))
UNION ALL
SELECT REINSADDMEMBERDETCODE FROM IM_REINSADDMEMBERDET WHERE REINSADDMEMBERPOLICYCODE
IN(SELECT REINSADDMEMBERPOLICYCODE FROM IM_REINS_ADDMEMBERPOLICY WHERE  Nvl(STATUS,0) = 0 AND SOURCETYPE = ATPASource AND  TPAPRODHDRCODE = Decode(Nvl(ATPAProductionCode,0),0,TPAPRODHDRCODE,ATPAProductionCode))))
 and (nvl(FINANCEPOSTDONEFORADDITION,1)+nvl(FINANCEPOSTDONEFORDELETION,1))<>2 -- and (memP.FINANCEPOSTDONEFORADDITION is not null or (select count(*) from IM_MEMPOLICYREFUNDPREMDTL DTL where memP.MEMBERPOLICYCODE=DTL.MEMBERPOLICYCODE)>0)-- or memP.FINANCEPOSTDONEFORDELETION is not null
 ) Pol
 where    (AddPremium+DeletePremium)<>0
 ;

LOOP
FETCH LCUR INTO
TABLEDATA.CARDNO,
TABLEDATA.MEMBER_ID,
TABLEDATA.MemberName,
TABLEDATA.StartDate,
TABLEDATA.EndDate,
TABLEDATA.AddPremium,
TABLEDATA.DeletePremium,
TABLEDATA.TYPEE,
TABLEDATA.POLICYCODE,
TABLEDATA.MEMBERCODE,
TABLEDATA.categoryName,
TABLEDATA.GroupCode
 ;

EXIT WHEN LCUR%NOTFOUND;
PIPE ROW(TABLEDATA);
END LOOP;
CLOSE LCUR;

END FN_POLICYFINANCEPOSTING;
/

