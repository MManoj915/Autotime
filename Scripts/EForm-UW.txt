SELECT HDR.BRANCHNAME,DISTRIBUTORTYPE,DISTRIBUTORNAME,PLANNAME,PRODUCTNAME,COUNTRYREGION,
CONTRACTNAME,MASTERCONTRACTNAME,CONTRACTEFFECTIVEDATE,CONTRACTEXPIRYDATE,
BENEFICIARYSTARTDATE,BENEFICIARYENDDATE,CONTRACTINCEPTIONDATE,POLICYNUMBER,RENEWALNUMBER,POLICYSTATUS,
BENEFICIARYID,PRINCIPALID,BENEFICIARYFIRSTNAME,
BENEFICIARYMIDDLENAME,BENEFICIARYLASTNAME,DEPENDENCY,DATEOFBIRTH,GENDER,BENEFICIARYNATIONALITY,
CARDNUMBER,LASTCARDNUMBER,ENDORESMENTDATE,ENDORESMENTISSUEDATE,ENDORESMENTID,ENDORESMENTTYPE,
MANAGEDBY,ADDPREMIUM,REFUNDPREMIUM,IPPREMIUM,OPPREMIUM,TOTALPREMIUM,UWYEAR,AGE,MARITALSTATUS,SALARYBAND,
SF_GETEFORMCOMMISSION(POLICYFINANCEPOSTINGCODE,1,AMOUNT, TOTALPREMIUM) AS AGENTCOM,
SF_GETEFORMCOMMISSION(POLICYFINANCEPOSTINGCODE,2,AMOUNT,TOTALPREMIUM) AS ADMINFEE,
SF_GETEFORMCOMMISSION(POLICYFINANCEPOSTINGCODE,3,AMOUNT,TOTALPREMIUM) AS TPAFEE,
ROUND(NVL(TOTALPREMIUM,0)*(NGIFEESPERCENTAGE/100),2)  NGI_FEES
FROM (SELECT M.*,(ADDPREMIUM+REFUNDPREMIUM) TOTALPREMIUM FROM(SELECT  SF_GETMAINBRANCH(IMP.MEMBERPOLICYCODE) BRANCHNAME,
SF_GETDISTRIBUTORTYPE(IMP.MEMBERPOLICYCODE)DISTRIBUTORTYPE,SF_GETDISTRIBUTORNAME(IMP.MEMBERPOLICYCODE) DISTRIBUTORNAME,
SF_GETPLANNAME(IMP.MEMBERPOLICYCODE) PLANNAME,Nvl(POL.POLICYNAME,IPOL.POLICYNAME) PRODUCTNAME,
Nvl(To_Char(POL.STARTDATE,'DD/MM/RRRR'),To_Char(IPOL.STARTDATE,'DD/MM/RRRR')) CONTRACTEFFECTIVEDATE,
NVL(To_CHAR(POL.ENDDATE,'DD/MM/RRRR'),To_CHAR(IPOL.ENDDATE,'DD/MM/RRRR')) CONTRACTEXPIRYDATE,
To_Char(IMP.MEMBERSTARTDATE,'DD/MM/RRRR') BENEFICIARYSTARTDATE,
To_Char(Nvl(IMP.MEMBERENDDATE,IMP.POLICYENDDDATE),'DD/MM/RRRR') BENEFICIARYENDDATE,
Nvl(To_Char(POL.STARTDATE,'DD/MM/RRRR'),To_Char(IPOL.STARTDATE,'DD/MM/RRRR')) CONTRACTINCEPTIONDATE,
Nvl(POL.POLICYID,IPOL.POLICYID) POLICYNUMBER, 
IMP.AMEMBERID BENEFICIARYID,MEM.MEMBER_ID PRINCIPALID,IM.FIRST_NAME BENEFICIARYFIRSTNAME,
IM.MIDDLENAME BENEFICIARYMIDDLENAME,IM.LAST_NAME BENEFICIARYLASTNAME,
DECODE(UPPER(GEN2.CONSTANTNAME),'SELF','PRINCIPAL','WIFE','SPOUSE','SON','CHILD','DAUGHTER','CHILD','DTR','CHILD','SPOUSE','SPOUSE') DEPENDENCY,
To_Char(IM.DATE_OF_BIRTH,'DD/MM/RRRR') DATEOFBIRTH,DECODE(IM.GENDER,0,'MALE',1,'FEMALE') GENDER,GEN.CONSTANTNAME BENEFICIARYNATIONALITY,
IMP.ACARDID CARDNUMBER,SF_GETRENEWALCARDNO(IMP.MEMBERPOLICYCODE) LASTCARDNUMBER,To_Char(JV.REFDATE,'DD/MM/RRRR') ENDORESMENTDATE,
To_Char(JV.REFDATE,'DD/MM/RRRR') ENDORESMENTISSUEDATE,JV.REF_NO ENDORESMENTID,
Decode(ADDPREMIUM,0,'DELETION','ADDITION') ENDORESMENTTYPE,    
(SELECT OWNERNAME FROM GETPOLICYNAME_VW WHERE POLICYCODE  = NVL(POL.POLICYCODE,IPOL.INDIVIDUALPOLICYCODE) AND 
TYPEE = Decode(JV.POLICYTYPE,0,1,2)) MANAGEDBY,
Decode(Nvl(JV.REVERSEJVCODE,0),0,(NVL(ABS(DTL.ADDPREMIUM),0)),(NVL(ABS(DTL.ADDPREMIUM),0))*-1) ADDPREMIUM,
Decode(Nvl(JV.REVERSEJVCODE,0),0,(NVL(ABS(DTL.REFUNDPREMIUM),0))*-1,(NVL(ABS(DTL.REFUNDPREMIUM),0))) REFUNDPREMIUM,
(SELECT (GETPREMIUMAMOUNT(DTL.POLICYFINANCEPOSTINGCODE,1)) FROM DUAL) IPPREMIUM,
(SELECT (GETPREMIUMAMOUNT(DTL.POLICYFINANCEPOSTINGCODE,2)) FROM DUAL) OPPREMIUM,
TO_CHAR(Nvl(POL.STARTDATE,IPOL.STARTDATE),'RRRR') UWYEAR,
Round((To_Date(IMP.MEMBERSTARTDATE,'DD/MM/RRRR')-To_Date(IM.DATE_OF_BIRTH,'DD/MM/RRRR'))/365.25) AGE,
G4.CONSTANTNAME MARITALSTATUS,GENC3.CONSTANTNAME SALARYBAND,
DECODE(JV.MEMOTYPE,1,NVL(POL.NGI_FEES,IPOL.NGI_FEES)*-1,NVL(POL.NGI_FEES,IPOL.NGI_FEES)*1)  NGIFEESPERCENTAGE,
JV.AMOUNT,DTL.POLICYFINANCEPOSTINGCODE,GRP.GROUP_NAME CONTRACTNAME,GRP1.GROUP_NAME MASTERCONTRACTNAME,'UAE' COUNTRYREGION,
SF_GETRENEWALNUMBER(IMP.MEMBERPOLICYCODE) RENEWALNUMBER,
Decode(Nvl(Nvl(POL.RENEWALPOLICYCODE,IPOL.RENEWALPOLICYCODE),0),0,'NEW','RENEWAL') POLICYSTATUS FROM 
IM_NGI_JVPOSTING JV
JOIN IM_POLICYFINANCEPOSTINGDTL DTL ON DTL.POLICYFINANCEPOSTINGCODE = JV.REF_CODE
LEFT JOIN IM_MEMBERPOLICY IMP ON IMP.MEMBERPOLICYCODE = DTL.MEMBERPOLICYCODE
LEFT JOIN IM_POLICY POL ON POL.POLICYCODE = JV.POLICYCODE AND JV.POLICYTYPE = 0
LEFT JOIN IM_INDIVIDUALPOLICY IPOL ON IPOL.INDIVIDUALPOLICYCODE = JV.POLICYCODE AND JV.POLICYTYPE = 1 
LEFT JOIN IM_MEMBERS IM ON IM.MEMBER_CODE = IMP.MEMBERCODE
LEFT JOIN IM_MEMBERS MEM ON MEM.MEMBER_CODE = IM.PARENT_ID
LEFT JOIN IM_GROUPS GRP ON GRP.GROUP_CODE = IM.GROUP_CODE
LEFT JOIN IM_GROUPS GRP1 ON GRP1.GROUP_CODE = IM.PARENTGROUPCODE
LEFT JOIN GENCONSTANT GENC3 ON GENC3.CATEGORY='SALARYBANDTYPE' AND GENC3.CONSTANTVALUE=IM.SALARYBAND AND UPPER(GENC3.LANGUAGECODE) = 'EN-US'
LEFT  JOIN GENCONSTANT G4 ON  G4.CATEGORY='MARITAL_STATUS' AND G4.CONSTANTVALUE=IM.MARITAL_STATUS AND UPPER(G4.LANGUAGECODE) = 'EN-US'
LEFT JOIN GENCONSTANT GEN ON GEN.CONSTANTVALUE = IM.NATIONALITY AND GEN.CATEGORY = 'FND_NATIONALITY' AND UPPER(GEN.LANGUAGECODE) = 'EN-US'
LEFT JOIN GENCONSTANT GEN2 ON GEN2.CONSTANTVALUE=IM.RELATION AND GEN2.CATEGORY='MEMBERRELATION' AND UPPER(GEN2.LANGUAGECODE) = 'EN-US'
WHERE  JVPREMIUMTYPE = 0
AND REFDATE BETWEEN TO_DATE('01/04/2016','DD/MM/RRRR')
AND TO_DATE('30/04/2016','DD/MM/RRRR') AND JV.REF_CODE = DTL.POLICYFINANCEPOSTINGCODE  AND DTL.MEMBERPOLICYCODE = IMP.MEMBERPOLICYCODE
AND NVL(IMP.A_SUBGROUPCODE,IMP.GROUPCODE) =  JV.GROUPCODE  AND   JV.GROUPCODE  IS NOT NULL
UNION ALL
SELECT  SF_GETMAINBRANCH(IMP.MEMBERPOLICYCODE) BRANCHNAME,
SF_GETDISTRIBUTORTYPE(IMP.MEMBERPOLICYCODE)DISTRIBUTORTYPE,SF_GETDISTRIBUTORNAME(IMP.MEMBERPOLICYCODE) DISTRIBUTORNAME,
SF_GETPLANNAME(IMP.MEMBERPOLICYCODE) PLANNAME,Nvl(POL.POLICYNAME,IPOL.POLICYNAME) PRODUCTNAME,
Nvl(To_Char(POL.STARTDATE,'DD/MM/RRRR'),To_Char(IPOL.STARTDATE,'DD/MM/RRRR')) CONTRACTEFFECTIVEDATE,
NVL(To_CHAR(POL.ENDDATE,'DD/MM/RRRR'),To_CHAR(IPOL.ENDDATE,'DD/MM/RRRR')) CONTRACTEXPIRYDATE,
To_Char(IMP.MEMBERSTARTDATE,'DD/MM/RRRR') BENEFICIARYSTARTDATE,
To_Char(Nvl(IMP.MEMBERENDDATE,IMP.POLICYENDDDATE),'DD/MM/RRRR') BENEFICIARYENDDATE,
Nvl(To_Char(POL.STARTDATE,'DD/MM/RRRR'),To_Char(IPOL.STARTDATE,'DD/MM/RRRR')) CONTRACTINCEPTIONDATE,
Nvl(POL.POLICYID,IPOL.POLICYID) POLICYID,
IMP.AMEMBERID BENEFICIARYID,MEM.MEMBER_ID PRINCIPALID,IM.FIRST_NAME BENEFICIARYFIRSTNAME,
IM.MIDDLENAME BENEFICIARYMIDDLENAME,IM.LAST_NAME BENEFICIARYLASTNAME,
DECODE(UPPER(GEN2.CONSTANTNAME),'SELF','PRINCIPAL','WIFE','SPOUSE','SON','CHILD','DAUGHTER','CHILD','DTR','CHILD','SPOUSE','SPOUSE') DEPENDENCY,
To_Char(IM.DATE_OF_BIRTH,'DD/MM/RRRR') DATEOFBIRTH,DECODE(IM.GENDER,0,'MALE',1,'FEMALE') GENDER,GEN.CONSTANTNAME BENEFICIARYNATIONALITY,
IMP.ACARDID CARDNUMBER,SF_GETRENEWALCARDNO(IMP.MEMBERPOLICYCODE) LASTCARDNUMBER,To_Char(JV.REFDATE,'DD/MM/RRRR') ENDORESMENTDATE,
To_Char(JV.REFDATE,'DD/MM/RRRR') ENDORESMENTISSUEDATE,JV.REF_NO ENDORESMENTID,
Decode(ADDPREMIUM,0,'DELETION','ADDITION') ENDORESMENTTYPE,  
(SELECT OWNERNAME FROM GETPOLICYNAME_VW WHERE POLICYCODE  = NVL(POL.POLICYCODE,IPOL.INDIVIDUALPOLICYCODE) AND 
TYPEE = Decode(JV.POLICYTYPE,0,1,2)) MANAGEDBY,
Decode(Nvl(JV.REVERSEJVCODE,0),0,(NVL(ABS(DTL.ADDPREMIUM),0)),(NVL(ABS(DTL.ADDPREMIUM),0))*-1) ADDPREMIUM,
Decode(Nvl(JV.REVERSEJVCODE,0),0,(NVL(ABS(DTL.REFUNDPREMIUM),0))*-1,(NVL(ABS(DTL.REFUNDPREMIUM),0))) REFUNDPREMIUM,
(SELECT (GETPREMIUMAMOUNT(DTL.POLICYFINANCEPOSTINGCODE,1)) FROM DUAL) IPPREMIUM,
(SELECT (GETPREMIUMAMOUNT(DTL.POLICYFINANCEPOSTINGCODE,2)) FROM DUAL) OPPREMIUM,
TO_CHAR(Nvl(POL.STARTDATE,IPOL.STARTDATE),'RRRR') UWYEAR,
Round((To_Date(IMP.MEMBERSTARTDATE,'DD/MM/RRRR')-To_Date(IM.DATE_OF_BIRTH,'DD/MM/RRRR'))/365.25) AGE,
G4.CONSTANTNAME MARITALSTATUS,GENC3.CONSTANTNAME SALARYBAND,
DECODE(JV.MEMOTYPE,1,NVL(POL.NGI_FEES,IPOL.NGI_FEES)*-1,NVL(POL.NGI_FEES,IPOL.NGI_FEES)*1)  NGIFEESPERCENTAGE,
JV.AMOUNT,DTL.POLICYFINANCEPOSTINGCODE,GRP.GROUP_NAME CONTRACTNAME,GRP1.GROUP_NAME MASTERCONTRACTNAME,'UAE' COUNTRYREGION,
SF_GETRENEWALNUMBER(IMP.MEMBERPOLICYCODE) RENEWALNUMBER,
Decode(Nvl(Nvl(POL.RENEWALPOLICYCODE,IPOL.RENEWALPOLICYCODE),0),0,'NEW','RENEWAL') POLICYSTATUS  FROM 
IM_NGI_JVPOSTING JV
JOIN IM_POLICYFINANCEPOSTINGDTL DTL ON DTL.POLICYFINANCEPOSTINGCODE = JV.REF_CODE
LEFT JOIN IM_MEMBERPOLICY IMP ON IMP.MEMBERPOLICYCODE = DTL.MEMBERPOLICYCODE
LEFT JOIN IM_POLICY POL ON POL.POLICYCODE = JV.POLICYCODE AND JV.POLICYTYPE = 0
LEFT JOIN IM_INDIVIDUALPOLICY IPOL ON IPOL.INDIVIDUALPOLICYCODE = JV.POLICYCODE AND JV.POLICYTYPE = 1 
LEFT JOIN IM_MEMBERS IM ON IM.MEMBER_CODE = IMP.MEMBERCODE
LEFT JOIN IM_MEMBERS MEM ON MEM.MEMBER_CODE = IM.PARENT_ID
LEFT JOIN IM_GROUPS GRP ON GRP.GROUP_CODE = IM.GROUP_CODE
LEFT JOIN IM_GROUPS GRP1 ON GRP1.GROUP_CODE = IM.PARENTGROUPCODE
LEFT JOIN GENCONSTANT GENC3 ON GENC3.CATEGORY='SALARYBANDTYPE' AND GENC3.CONSTANTVALUE=IM.SALARYBAND AND UPPER(GENC3.LANGUAGECODE) = 'EN-US'
LEFT JOIN GENCONSTANT   G4 ON  G4.CATEGORY='MARITAL_STATUS' AND G4.CONSTANTVALUE=IM.MARITAL_STATUS AND UPPER(G4.LANGUAGECODE) = 'EN-US'
LEFT JOIN GENCONSTANT GEN ON GEN.CONSTANTVALUE = IM.NATIONALITY AND GEN.CATEGORY = 'FND_NATIONALITY' AND UPPER(GEN.LANGUAGECODE) = 'EN-US'
LEFT JOIN GENCONSTANT GEN2 ON GEN2.CONSTANTVALUE=IM.RELATION AND GEN2.CATEGORY='MEMBERRELATION' AND UPPER(GEN2.LANGUAGECODE) = 'EN-US'
WHERE  JVPREMIUMTYPE = 0
AND REFDATE BETWEEN TO_DATE('01/04/2016','DD/MM/RRRR')
AND TO_DATE('30/04/2016','DD/MM/RRRR') AND JV.REF_CODE = DTL.POLICYFINANCEPOSTINGCODE
AND JV.GROUPCODE  IS NULL)M)HDR