BEGIN
FOR HDR IN(SELECT * FROM IM_TREATY_HDR WHERE TREATYNAME IN
(SELECT TREATYNAME FROM IM_RI_SESSION_UW_HDR WHERE POLICYID IN('9392-1','9424-1','9427-1','9453-1','9479-1','9482-1'))
) LOOP
IF HDR.COMMISSION = 'Y' AND HDR.NGIFEE = 'Y' THEN
  UPDATE IM_RI_SESSION_UW_HDR SET NETAMOUNT =  TOTALPREMIUM+COMMISSION+NGIFEE  WHERE TREATYNAME = HDR.TREATYNAME;
  COMMIT;
END IF;
IF HDR.COMMISSION = 'Y' AND HDR.NGIFEE = 'N' THEN
  UPDATE IM_RI_SESSION_UW_HDR SET NETAMOUNT =  TOTALPREMIUM+COMMISSION  WHERE TREATYNAME = HDR.TREATYNAME;
  COMMIT;
END IF;
IF HDR.COMMISSION = 'N' AND HDR.NGIFEE = 'Y' THEN
  UPDATE IM_RI_SESSION_UW_HDR SET NETAMOUNT =  TOTALPREMIUM+NGIFEE  WHERE TREATYNAME = HDR.TREATYNAME;
  COMMIT;
END IF;
IF HDR.COMMISSION = 'N' AND HDR.NGIFEE = 'N' THEN
  UPDATE IM_RI_SESSION_UW_HDR SET NETAMOUNT =  TOTALPREMIUM  WHERE TREATYNAME = HDR.TREATYNAME;
  COMMIT;
END IF;

END LOOP;
END;



INSERT INTO IM_RI_SESSION_UW_HDR
SELECT H.*,Round((TOTALPREMIUM*(7.5/100)),2) NGIFEE FROM(SELECT DISTINCT TRT.TREATYNAME,ENDORESMENTID,To_Date(A.ENDORESMENTDATE,'DD/MM/RRRR') DOCUMENTNAME,INS.INS_NAME,TDTL.FACULTATIVEPERCENTAGE,
A.ACC_PIN,P.POLICYID,P.POLICYNAME,Sum(TOTALPREMIUM)*(TDTL.FACULTATIVEPERCENTAGE/100) TOTALPREMIUM,0 CLAIMAMOUNT,A.UWYEAR,
Sum(TOTALPREMIUM) DOCUMENTAMOUNT,0 NETPREMIUM,Round((Sum(AGENTCOM+A.TPAFEE+ADMINFEE)*(TDTL.FACULTATIVEPERCENTAGE/100)),2) COMMISSION,DTL.FACULTATIVEPERCENTAGE TREATYPERCENTAGE,G.CONSTANTNAME,
A.MANAGEDBY,A.BRANCHNAME,P.STARTDATE,P.ENDDATE 
 FROM ICA A,IM_POLICY P,IM_POLICY_INSURER_DTL DTL,IM_POLICY_INSURER_SUBDTL SDTL,
IM_TREATY_HDR TRT,IM_TREATY_DTL TDTL,GENCONSTANT G,IM_INSURER INS 
WHERE To_Date(ENDORESMENTDATE,'DD/MM/RRRR')
BETWEEN To_Date('01/01/2018','DD/MM/RRRR') AND To_Date('31/10/2018','DD/MM/RRRR')  
AND Upper(POLICYTYPE) = 'GROUP' AND A.POLICYNUMBER = P.POLICYID   AND P.POLICYCODE = DTL.POLICYCODE
AND P.POLICYID IN('9392-1','9424-1','9427-1','9453-1','9479-1','9482-1')
AND DTL.POLICYINSURERDTLCODE = SDTL.POLICYINSURERDTLCODE  AND SDTL.TREATYHDRCODE = TRT.TREATYHDRCODE 
AND G.CATEGORY='PREMIUMTYPES' AND G.LANGUAGECODE = 'en-US' AND G.CONSTANTVALUE = SDTL.PREMIUMTYPE
AND TRT.TREATYHDRCODE = TDTL.TREATYHDRCODE AND P.OWNERCODE NOT IN(11,14,15,22,23) AND INS.INSCODE = TDTL.INSURERCODE 
AND SDTL.PREMIUMTYPE = 4     --AND ENDORESMENTID='02181123561'
GROUP BY POLICYNUMBER,ENDORESMENTID,TRT.TREATYNAME,INS.INS_NAME,TDTL.FACULTATIVEPERCENTAGE,G.CONSTANTNAME,
TRT.CALCULATIONTYPE,SDTL.PREMIUMTYPE,To_Date(A.ENDORESMENTDATE,'DD/MM/RRRR'),A.ACC_PIN,P.POLICYID,P.POLICYNAME,A.UWYEAR,
A.MANAGEDBY,A.BRANCHNAME,DTL.FACULTATIVEPERCENTAGE,P.STARTDATE,P.ENDDATE )H

                                              

UPDATE IM_RI_SESSION_UW_HDR SET NGIFEE = Abs(NGIFEE)*-1 WHERE TOTALPREMIUM > 0 AND NGIFEE > 0;
COMMIT;
UPDATE IM_RI_SESSION_UW_HDR SET NGIFEE = Abs(NGIFEE)*1 WHERE TOTALPREMIUM < 0 AND NGIFEE < 0;
COMMIT;





SELECT TOTALPREMIUM,NETAMOUNT,COMMISSION,NGIFEE,(NETAMOUNT-COMMISSION-NGIFEE) FROM IM_RI_SESSION_UW_HDR  WHERE POLICYID IN('9392-1','9424-1','9427-1','9453-1','9479-1','9482-1')
