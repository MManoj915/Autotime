SELECT HDR.ACR_FORM_NO CLAIMNUMBER,HDR.INVOICENUMBER,To_Date(HDR.TRANSACTIONDATE,'DD/MM/RRRR') REPORTEDDATE,
To_Date(HDR.ENCOUNTER_START_DATE,'DD/MM/RRRR') TREATMENTDATE,To_Date(HDR.ENCOUNTER_END_DATE,'DD/MM/RRRR') DISCHARGEDATE,
HDR.CARDNO,MPOL.APOLICYID POLICYID,G.CONSTANTNAME MANAGEDBY,PRO.PROVIDERID,G1.CONSTANTNAME PROVIDERTYPE,PRO.PROVIDERNAME,
CLI.LICENSEID,CLI.NAME,G2.CONSTANTNAME TREATMENTTYPE,  
(SELECT LISTAGG(IMVD.CODE, ',') WITHIN GROUP(ORDER BY IMVD.CODE)
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_ACTIVITY_TYPES ACTTYP
ON ACTTYP.TYPECODE = DTL.ACTIVITY_CODE
JOIN IM_VERSION_DETALIS IMVD
ON IMVD.DETAILCODE = DTL.VERSIONDETAILCODE
WHERE ACTTYP.VALUE = -1
AND DTL.CLAIM_CODE = HDR.CLAIM_CODE
AND DTL.TYPE = 1 
GROUP BY DTL.CLAIM_CODE) PRIMARYICDCODE,
(SELECT LISTAGG(IMVD.SHORTDESC, ',') WITHIN GROUP(ORDER BY IMVD.SHORTDESC)
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_ACTIVITY_TYPES ACTTYP
ON ACTTYP.TYPECODE = DTL.ACTIVITY_CODE
JOIN IM_VERSION_DETALIS IMVD
ON IMVD.DETAILCODE = DTL.VERSIONDETAILCODE
WHERE ACTTYP.VALUE = -1
AND DTL.CLAIM_CODE = HDR.CLAIM_CODE
AND DTL.TYPE = 1 
GROUP BY DTL.CLAIM_CODE) PRIMARYICDDESCRIPTION,
(SELECT LISTAGG(IMVD.CODE, ',') WITHIN GROUP(ORDER BY IMVD.CODE)
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_ACTIVITY_TYPES ACTTYP
ON ACTTYP.TYPECODE = DTL.ACTIVITY_CODE
JOIN IM_VERSION_DETALIS IMVD
ON IMVD.DETAILCODE = DTL.VERSIONDETAILCODE
WHERE ACTTYP.VALUE = -1
AND DTL.CLAIM_CODE = HDR.CLAIM_CODE
AND DTL.TYPE = 2 
GROUP BY DTL.CLAIM_CODE) SECONDARYICDCODE,
(SELECT LISTAGG(IMVD.SHORTDESC, ',') WITHIN GROUP(ORDER BY IMVD.SHORTDESC)
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_ACTIVITY_TYPES ACTTYP
ON ACTTYP.TYPECODE = DTL.ACTIVITY_CODE
JOIN IM_VERSION_DETALIS IMVD
ON IMVD.DETAILCODE = DTL.VERSIONDETAILCODE
WHERE ACTTYP.VALUE = -1
AND DTL.CLAIM_CODE = HDR.CLAIM_CODE
AND DTL.TYPE = 2 
GROUP BY DTL.CLAIM_CODE) SECONDARYICDDESCRIPTION ,
Decode(NVL(DTL.TYPE,0),0,IVD.CODE,NULL) CPTCODE,Decode(NVL(DTL.TYPE,0),0,IVD.SHORTDESC,NULL) CPTDESCRIPTION,
IBC.BENEFIT_ID,IBC.BENEFIT_NAME,
Decode(HDR.REQUEST_TYPE,4,HDR.REQUEST_AMOUNT,DTL.REQUESTAMOUNT) REQUESTAMOUNT,Decode(HDR.REQUEST_TYPE,4,0,DTL.COINSURANCE_AMOUNT) COINSURANCE_AMOUNT,
Decode(HDR.REQUEST_TYPE,4,HDR.DEDUCTABLEVALUE,DTL.DEDUCTIBLE_AMOUNT) DEDUCTIBLE_AMOUNT,Decode(HDR.REQUEST_TYPE,4,HDR.DENAILVALUE,DTL.DENIAL_VALUE),
IVD2.CODE DENIAL_REASON,
Decode(HDR.REQUEST_TYPE,3,Nvl(Decode(HDR.REQUEST_TYPE,4,HDR.APPROVED_AMOUNT,DTL.TOTAL),0),4,Nvl(Decode(HDR.REQUEST_TYPE,4,HDR.APPROVED_AMOUNT,DTL.TOTAL),0),
(Nvl(Decode(HDR.REQUEST_TYPE,4,HDR.APPROVED_AMOUNT,DTL.TOTAL),0)+
(SELECT NVL(SUM(NVL(VW.DENIEDAMOUNT,0)),0) FROM IM_DECLINEAMOUNT_VW VW WHERE VW.ACTIVITY_DETAIL_CODE = DTL.ACTIVITY_DETAIL_CODE))) APPROVEDAMOUNT,  
HR.SHORT_NAME BRANCH  FROM   IM_CLAIM_PROCESS_HEADER HDR 
LEFT JOIN IM_CLAIM_PROCESS_DETAIL DTL ON DTL.CLAIM_CODE = HDR.CLAIM_CODE    AND HDR.REQUEST_TYPE <> 4      AND Nvl(DTL.TYPE,0) = 0
LEFT JOIN IM_MEMBERPOLICY MPOL ON MPOL.MEMBERPOLICYCODE = HDR.MEMBERPOLICYCODE
LEFT JOIN IM_POLICY POL ON POL.POLICYCODE = MPOL.POLICYCODE AND MPOL.TYPEE = 1
LEFT JOIN IM_INDIVIDUALPOLICY IPOL ON IPOL.INDIVIDUALPOLICYCODE = MPOL.POLICYCODE AND MPOL.TYPEE = 2
LEFT JOIN GENCONSTANT G ON G.CATEGORY = 'NGIQUOTATIONTYPE' AND G.CONSTANTVALUE = Nvl(POL.OWNERCODE,IPOL.OWNERCODE) AND UPPER(G.LANGUAGECODE) = 'EN-US'
LEFT JOIN IM_VERSION_DETALIS IVD ON IVD.DETAILCODE = DTL.VERSIONDETAILCODE  
LEFT JOIN IM_PROVIDERS PRO ON PRO.PROVIDERCODE = HDR.PROVIDER_CODE
LEFT JOIN HR_ORGANIZATIONS_D HR ON HR.ORGANIZATIONS_CODE = Nvl(POL.BRANCHCODE,IPOL.BRANCHCODE)
LEFT JOIN GENCONSTANT G1 ON G1.CATEGORY = 'PROVIDERTYPE' AND G1.CONSTANTVALUE = PRO.PROVIDERTYPE AND UPPER(G1.LANGUAGECODE) = 'EN-US'
LEFT JOIN GENCONSTANT G2 ON G2.CATEGORY = 'APPLICABLE' AND G2.CONSTANTVALUE = HDR.TREATMENT_TYPE AND UPPER(G2.LANGUAGECODE) = 'EN-US' 
LEFT JOIN IM_CLINICIANS CLI ON CLI.CDCODE = DTL.CLINICIAN_CODE 
LEFT JOIN IM_VERSION_DETALIS IVD2 ON IVD2.DETAILCODE = DTL.DENIAL_REASON
LEFT JOIN IM_BENEFIT_CODES IBC ON IBC.BENEFIT_CODE = DTL.BENEFIT_CODE  
WHERE Nvl(HDR.ISPOSTED,0) = 0   AND HDR.REQUEST_TYPE <> 4    AND HDR.CLAIM_STATUS = 2 
AND To_Date(HDR.TRANSACTIONDATE,'DD/MM/RRRR') > To_Date('01/01/2018','DD/MM/RRRR')