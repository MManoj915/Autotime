PROMPT CREATE OR REPLACE FUNCTION ngi_pr_create_policy_orafnc
CREATE OR REPLACE FUNCTION ngi_pr_create_policy_orafnc(P_PAYMENTCODE NUMBER,P_SPONSORCODE NUMBER,P_CREATEDBY NUMBER,P_RESULT OUT NUMBER) RETURN VARCHAR2
AS
L_ERROR VARCHAR2(1000);L_SEQ NUMBER;
L_SPONSOR_ROW IM_PR_SPONSOR%ROWTYPE;
L_SPONSOR_APP_ROW IM_PR_SPONSOR_APPLICATION%ROWTYPE;
L_STAFF_ROW IM_PR_STAFF%ROWTYPE;
L_IPPOLICY_ROW IM_INDIVIDUALPOLICY%ROWTYPE;
L_POLICY_ROW IM_POLICY%ROWTYPE;
L_OWNERCODE VARCHAR2(1000);
L_POLICYID VARCHAR2(1000);
L_POLICYNAME VARCHAR2(1000);
L_SOURCETYPE NUMBER;L_SOURCECODE NUMBER;L_SOURCENAME VARCHAR2(500);
L_APPLICANTID VARCHAR2(100);L_BRANCH NUMBER;
L_OTHERBILLINGCODE NUMBER;L_OTHERBILLINGNAME VARCHAR2(500);
L_NGIFEE NUMBER;
L_RULES VARCHAR2(1000);V_RESULT  VARCHAR2(1000);
L_FINANCENO NUMBER;L_PRIMKEY NUMBER;L_SNO NUMBER;
L_ADDPREMIUM NUMBER;L_REFUNDPREMIUM NUMBER;
L_STAFFCOUNT NUMBER;L_AGENTCODE NUMBER;L_ERRORCOUNT NUMBER;
L_AGENTCOUNT NUMBER;L_INDIVIDUALPOLICYCODE NUMBER;
L_INDIVIDUALPOLICYCOUNT NUMBER;L_GROUPCODE NUMBER;L_MEMCODE NUMBER;
L_AGENTNAME  VARCHAR2(1000); L_POLICYCODE NUMBER; L_MEMPOLICYCODE NUMBER;
L_DEFAULTVALUE NUMBER;L_POLICYCOUNT NUMBER;L_LICENSECOUNT NUMBER;
BEGIN

SELECT * INTO L_SPONSOR_ROW FROM IM_PR_SPONSOR WHERE SPONSOR_CODE = P_SPONSORCODE ;

UPDATE IM_PR_SPONSOR_APPLICATION SET PAYMENTCODE = P_PAYMENTCODE,PAYMENTSTATUS = 3
WHERE APPLICATIONCODE IN((SELECT APPLICATIONCODE FROM IM_PR_PAYMENT_DTL WHERE PAYMENTCODE=P_PAYMENTCODE));
COMMIT;
SELECT * INTO L_SPONSOR_APP_ROW FROM   IM_PR_SPONSOR_APPLICATION
WHERE APPLICATIONCODE IN(SELECT APPLICATIONCODE FROM IM_PR_PAYMENT_DTL WHERE PAYMENTCODE=P_PAYMENTCODE);
IF Nvl(L_SPONSOR_ROW.STAFFCODE,0) <> 0 THEN
  SELECT * INTO L_STAFF_ROW FROM IM_PR_STAFF WHERE STAFFCODE = L_SPONSOR_ROW.STAFFCODE;
  IF L_STAFF_ROW.EMPTYPE = 1 THEN
     L_SOURCETYPE := 4;
     L_SOURCECODE := L_STAFF_ROW.EMPCODE;
     SELECT BRANCHCODE,AGENT_NAME_EN INTO L_BRANCH,L_SOURCENAME FROM IM_AGENTS   WHERE AGENTCODE=L_STAFF_ROW.EMPCODE;
  ELSIF L_STAFF_ROW.EMPTYPE = 2 THEN
     L_SOURCETYPE := 5;
     L_SOURCECODE := L_STAFF_ROW.EMPCODE;
     SELECT BRANCHCODE,BROKER_NAME_EN INTO L_BRANCH,L_SOURCENAME FROM IM_BROKERS   WHERE BROKERCODE=L_STAFF_ROW.EMPCODE;
  END IF;
ELSE
  L_SOURCETYPE := 3;
  L_SOURCECODE := 100000000000000004;
  SELECT BRANCHCODE,AGENT_NAME_EN INTO L_BRANCH,L_SOURCENAME FROM IM_AGENTS   WHERE AGENTCODE=100000000000000004;
END IF;

IF L_SPONSOR_ROW.POLICYTYPE = 2 THEN

  SELECT Count(*) INTO L_POLICYCOUNT FROM IM_INDIVIDUALPOLICY WHERE  LOGCODE = L_SPONSOR_ROW.SPONSOR_CODE AND PORTALTYPE='PR';
  IF L_POLICYCOUNT = 0 THEN
    SELECT IM_PR_POLICY_SEQ.NEXTVAL INTO L_SEQ FROM DUAL;
    IF Length(L_SEQ)  = 1 THEN
      SELECT LPAD(L_SEQ, 5, '0') INTO L_SEQ FROM DUAL;
    ELSIF Length(L_SEQ) = 2 THEN
      SELECT LPAD(L_SEQ, 5, '0') INTO L_SEQ FROM DUAL;
    ELSIF  Length(L_SEQ) = 3 THEN
      SELECT LPAD(L_SEQ, 5, '0') INTO L_SEQ FROM DUAL;
    ELSIF  Length(L_SEQ) = 4 THEN
      SELECT LPAD(L_SEQ, 5, '0') INTO L_SEQ FROM DUAL;
    END IF;
    L_POLICYID := 'PR-'||L_SEQ||'-01';
    L_POLICYNAME := L_POLICYID||'-'||L_SPONSOR_ROW.FIRST_NAME||' '||L_SPONSOR_ROW.LAST_NAME||'-'||TO_CHAR(To_Date(SYSDATE,'DD/MM/RRRR'),'RRRR');
    INSERT INTO IM_INDIVIDUALPOLICY
    (INDIVIDUALPOLICYCODE,
    POLICYID, POLICYNAME, STARTDATE, ENDDATE, GROUPCODE,
    ISFRONTINGGROUP, CATEGORYCODE, PLANCODE, ACTIVE, CALCULATEFINE,
    FINETEMPLATECODE, FRONTINGSETTING, REMARKS, CREATEDIN, CREATEDON,
    CREATEDBY, LASTMODIFIEDON, LASTMODIFIEDBY, COMPANYCODE, LOCATIONCODE,
    DEACTIVATEDON, DEACTIVATEDBY, SERIALNO, ALTERNATENAME, ANUALLIMITSTYPECODE,
    INPATENTSLIMITSTYPECODE, OUTPATENTSLIMITSTYPECODE, ALTLIMITS, IPTLIMITS, OPTLIMITS,
    IPPREFIX, IPNO, IPSUFFIX, IPFULLNO, AUTHORIZEDSTATUS,
    MEMBERCODE, FINAL_PREMIUM, BASE_PERIMUM, PERIMUMCODE, ELEMENTTEMPLATECODE,
    ISMEMBERPOLICYCONVERTED, TEMPLATECODE, COMMISIONTYPE, AGENTCODE, BROKERCODE,
    OWNERCODE, HAADAPPROVALCODE, REINSURANCECODE, OLDPOLICYCODE, RENEWALPOLICYCODE,
    INDIPOLICYSOURCECODE, PAYMENTMODE, CONTRACTTYPE, INSURANCECO, EXCELVALIDATE,
    BILLINGTYPE, BRANCHCODE, POLICYSERIALNO, POSTINGDONE, NGI_FEES,
    INCEPTIONPREMIUM, ISCAPTIVE, ENTITYTYPE, ENTITYID, CONTACTNUMBER,
    EMAILID, PORTALMEMBERID,LOGCODE,PORTALTYPE,A_POLICYTYPE,SPONSORCODE)
    VALUES
    ((SELECT MAX(INDIVIDUALPOLICYCODE) + 1  FROM IM_INDIVIDUALPOLICY),L_POLICYID, L_POLICYNAME,
    SYSDATE,SYSDATE+364,NULL,0, NULL, NULL, 1,0, NULL, NULL, NULL, NULL,
    SYSDATE, 100000000000000002,SYSDATE, 100000000000000002, 1,
    1, NULL, NULL, (SELECT MAX(SERIALNO) + 1 FROM IM_INDIVIDUALPOLICY), NULL,
    0, 0, 0, 0, 0,0, NULL,NULL, NULL, '',
    0, 100000000000339720, 0, 0, 0,
    NULL, 0, '65', 0,Decode(L_SOURCETYPE,5,NULL,L_SOURCECODE),
    Decode(L_SOURCETYPE,5,L_SOURCECODE,NULL),L_SPONSOR_ROW.ADMINISTRATEDBY, NULL, NULL, NULL,
    NULL, L_SOURCETYPE, 0, 0, NULL,0,Decode(L_SOURCETYPE,5,1,0), L_BRANCH, 1, 0,
    11, NULL, NULL, NULL, NULL,NULL, NULL,L_APPLICANTID,L_SPONSOR_ROW.SPONSOR_CODE,'PR',2,L_SPONSOR_ROW.SPONSOR_CODE);
    COMMIT;

    SELECT INDIVIDUALPOLICYCODE INTO L_INDIVIDUALPOLICYCODE FROM IM_INDIVIDUALPOLICY WHERE POLICYID = L_POLICYID;
    SELECT * INTO L_IPPOLICY_ROW FROM IM_INDIVIDUALPOLICY WHERE POLICYID = L_POLICYID;

    INSERT INTO IM_NGIINDPOLICYCATEGORY
    (POLICYCATEGORYCODE, INDIVIDUALPOLICYCODE, CATEGORYCODE, ALTLIMIT, IPLIMIT, PLANCODE, CALCULATEFINE, ISFRONTINGGROUP, COMPANYCODE, CREATEDBY, LASTMODIFIEDBY, CREATEDON, LASTMODIFIEDON, LOCATIONCODE, SERIALNO, OPLIMIT, ACTIVE, MEMBERCODE, ROOMTYPE, EMGDETECTWINETWTYPE, EMGDETECTWINETWVALUE, EMGDETECTOONETWTYPE, EMGDETECTOONETWVALUE, TOTALPREMIUM, LIMITTYPE, DEDECTABLETYPE, DEDECTABLEVALUE, LIMITS, CO_IN_TYPE, CO_IN_VALUE, OONDEDECTABLETYPE, OONDEDECTABLEVALUE, OONCO_IN_TYPE, OONCO_IN_VALUE, ALERTCLAIMSTEAMREMARK, EMIRATECODE)
    VALUES
      ((SELECT MAX(POLICYCATEGORYCODE) + 1 FROM IM_NGIINDPOLICYCATEGORY), L_INDIVIDUALPOLICYCODE, 100000000000000001, 150000, 150000,
        100000000000000474, 1, 0,
        1, 100000000000000657, 100000000000000657,SYSDATE, SYSDATE,
        1, (SELECT MAX(SERIALNO) + 1 FROM IM_NGIINDPOLICYCATEGORY), 0, 1,
        100000000000313952, 0, 2, 0,
        2, 0, 0, 0,
        0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 100000000000001994);
    COMMIT;
    --1 - IP,2 - OP,3 - Other,4 - Base
    IF L_SPONSOR_ROW.ADMINISTRATEDBY = 11 THEN
      L_RULES := INSERTTPATREATY(L_INDIVIDUALPOLICYCODE,1,100000000000000210); --Hannover
      L_RULES := INSERTTPATREATY(L_INDIVIDUALPOLICYCODE,2,100000000000000209); --FMC
      L_RULES := INSERTTPATREATY(L_INDIVIDUALPOLICYCODE,3,100000000000000214); --Own
      L_RULES := INSERTTPATREATY(L_INDIVIDUALPOLICYCODE,5,100000000000000213); --Daycare
    ELSIF L_SPONSOR_ROW.ADMINISTRATEDBY = 3 THEN
      L_RULES := INSERTTPATREATY(L_INDIVIDUALPOLICYCODE,3,100000000000000210); -- Hannover
      L_RULES := INSERTTPATREATY(L_INDIVIDUALPOLICYCODE,4,100000000000000210);  -- Hannover
    ELSIF L_SPONSOR_ROW.ADMINISTRATEDBY = 1 THEN
       L_RULES := INSERTTPATREATY(L_INDIVIDUALPOLICYCODE,3,100000000000000211); -- AWZ Blue
       L_RULES := INSERTTPATREATY(L_INDIVIDUALPOLICYCODE,4,100000000000000211);  -- AWZ Blue
    END IF;

    Insert into IM_IP_COMMISSION
    (IP_COMM_CODE, INDIVIDUALPOLICYCODE, COMISSION_TYPES, DEFAULTVALUE, CALC_METHOD, COMMISSION_VALUE, CREATEDIN, CREATEDON, CREATEDBY, LASTMODIFIEDON, LASTMODIFIEDBY, LEGALENTITYCODE, CUSTOMERCODE, LOCATIONCODE, SERIALNO, COMPANYCODE, COMMISSIONTO, INDPOLCYCOMMISIONTO)
    Values
    ((SELECT MAX(IP_COMM_CODE) + 1 FROM IM_IP_COMMISSION), L_INDIVIDUALPOLICYCODE, 1,Decode(L_SOURCETYPE,3,0,5), 1,
    Decode(L_SOURCETYPE,3,0,5), 1,SYSDATE, 100000000000000002,SYSDATE,
    100000000000000002, 100000000000000001, 100000000000000001,1,(SELECT MAX(SERIALNO) + 1 FROM IM_IP_COMMISSION),
    1, L_SOURCECODE,L_SOURCENAME);
    COMMIT;
    IF L_SPONSOR_ROW.ADMINISTRATEDBY = 11 THEN
      L_OTHERBILLINGCODE :=  100000000000000090;
      L_OTHERBILLINGNAME := 'FMC TPA FEE AND CLAIMS FEE';
    ELSIF L_SPONSOR_ROW.ADMINISTRATEDBY = 1 THEN
      L_OTHERBILLINGCODE :=  100000000000000027;
      L_OTHERBILLINGNAME := 'NEXT CARE PREMIUM AND COM ACCOUNT';
    END IF;
    IF L_SPONSOR_ROW.ADMINISTRATEDBY <> 3 THEN
      Insert into IM_IP_COMMISSION
      (IP_COMM_CODE, INDIVIDUALPOLICYCODE, COMISSION_TYPES, DEFAULTVALUE, CALC_METHOD, COMMISSION_VALUE, CREATEDIN, CREATEDON, CREATEDBY, LASTMODIFIEDON, LASTMODIFIEDBY, LEGALENTITYCODE, CUSTOMERCODE, LOCATIONCODE, SERIALNO, COMPANYCODE, INDPOLCYCOMMISIONTO, GENERALCOMMBILLINGCODE)
      Values
      ((SELECT MAX(IP_COMM_CODE) + 1 FROM IM_IP_COMMISSION), L_INDIVIDUALPOLICYCODE, 2,5, 1,
      5, 1, SYSDATE, 100000000000000002,SYSDATE,
      100000000000000002, 100000000000000001, 100000000000000001, 1, (SELECT MAX(SERIALNO) + 1 FROM IM_IP_COMMISSION),
      1,'FMC TPA FEE AND CLAIMS FEE',100000000000000090);
      COMMIT;
    END IF;

    UPDATE IM_INDIVIDUALPOLICY SET AUTHORIZEDSTATUS = 1,POSTINGDONE = 1 WHERE INDIVIDUALPOLICYCODE = L_INDIVIDUALPOLICYCODE;
    COMMIT;

  ELSE
    SELECT * INTO L_IPPOLICY_ROW FROM IM_INDIVIDUALPOLICY WHERE  LOGCODE = L_SPONSOR_ROW.SPONSOR_CODE AND PORTALTYPE='PR';
  END IF;


ELSIF L_SPONSOR_ROW.POLICYTYPE = 1 THEN  -- GROUP POLICY

  SELECT Count(*) INTO L_POLICYCOUNT FROM IM_POLICY WHERE LOGCODE = L_SPONSOR_ROW.SPONSOR_CODE AND PORTALTYPE='PR';
  IF L_POLICYCOUNT = 0 THEN
    SELECT IM_PR_POLICY_SEQ.NEXTVAL INTO L_SEQ FROM DUAL;
    IF Length(L_SEQ)  = 1 THEN
      SELECT LPAD(L_SEQ, 5, '0') INTO L_SEQ FROM DUAL;
    ELSIF Length(L_SEQ) = 2 THEN
      SELECT LPAD(L_SEQ, 5, '0') INTO L_SEQ FROM DUAL;
    ELSIF  Length(L_SEQ) = 3 THEN
      SELECT LPAD(L_SEQ, 5, '0') INTO L_SEQ FROM DUAL;
    ELSIF  Length(L_SEQ) = 4 THEN
      SELECT LPAD(L_SEQ, 5, '0') INTO L_SEQ FROM DUAL;
    END IF;
    L_POLICYID := 'PR-'||L_SEQ||'-01';
    L_POLICYNAME := L_POLICYID||'-'||L_SPONSOR_ROW.FIRST_NAME||' '||L_SPONSOR_ROW.LAST_NAME||'-'||TO_CHAR(To_Date(SYSDATE,'DD/MM/RRRR'),'RRRR');

    Insert into IM_GROUPS
    (GROUP_CODE,GROUP_NUMBER, GROUP_NAME, ADDRESS, REMARKS, CURRENCY_CODE,
    NATURE_OF_BUSSINESS, STATUS, COMPANYCODE, CREATEDBY, LASTMODIFIEDBY,
    CREATEDON, LASTMODIFIEDON, LOCATIONCODE, SERIALNO, GROUP_ID,
    PARENT_GROUP, ISMANUALMEMBER, PICTURE, ISSTAFFNONEEDED, ISGROUPLOGONEEDED,
    ISHATHNONEEDED, PRINTGROUPTYPE, REDCARDTEXT, USERNAME, PASSWORD)
    Values
    ((SELECT MAX(GROUP_CODE) + 1 FROM IM_GROUPS),L_POLICYID, L_SPONSOR_ROW.FIRST_NAME||' ' ||L_SPONSOR_ROW.LAST_NAME,NULL, NULL,
    0,L_POLICYID, 0, 1, 100000000000000002, 100000000000000002,SYSDATE,SYSDATE,
    1, (SELECT MAX(SERIALNO) + 1 FROM IM_GROUPS),L_POLICYID, NULL, 0, NULL, 0,
    0, 0, 0, NULL,L_POLICYID,'123456');
    COMMIT;

    SELECT Max(GROUP_CODE) INTO L_GROUPCODE FROM IM_GROUPS WHERE Upper(NATURE_OF_BUSSINESS) = Upper(L_POLICYID);

    Insert into IM_POLICY
    (POLICYCODE,
    POLICYID, POLICYNAME, STARTDATE, ENDDATE, GROUPCODE,
    ISFRONTINGGROUP, CATEGORYCODE, PLANCODE, ACTIVE, CALCULATEFINE,
    FINETEMPLATECODE, REMARKS, CREATEDIN, CREATEDON, CREATEDBY,
    LASTMODIFIEDON, LASTMODIFIEDBY, COMPANYCODE, LOCATIONCODE, DEACTIVATEDON,
    DEACTIVATEDBY, SERIALNO, FRONTINGSETTING, ANNUALLIMITTYPE, ALTLIMIT,
    INPATIENT, IPLIMIT, OUTPATIENT, OPLIMIT, AUTHORIZEDSTATUS,
    POLICYPREFIX, POLICYNO, POLICYSUFFIX, POLICYFULLNO, MEMBERCODE,
    FINAL_PREMIUM, BASE_PERIMUM, PERIMUMCODE, ELEMENTTEMPLATECODE, ISMEMBERPOLICYCONVERTED,
    UBIPCODE, COMMISIONTYPE, AGENTCODE, BROKERCODE, OWNERCODE,
    OLDPOLICYCODE, RENEWALPOLICYCODE, REQUEST_SOURCE, HAADAPPROVALCODE, REINSURANCECODE,
    PAYMENTMODE, CONTRACTTYPE, INSURANCECO, EXCELVALIDATE, TEMPLATECODE,
    BILLINGTYPE, BRANCHCODE, POLICYSERIALNO, OLDFINAL_PREMIUM, POSTINGDONE,
    NGI_FEES, INCEPTIONPREMIUM, ISCAPTIVE, ENTITYTYPE, ENTITYID,
    CONTACTNUMBER, EMAILID, FRONTINGFEES, REINSURERTYPE, SUBREINSURERTYPE,
    NOOFINSTALLMENT, EXCELFILENAME, TREATYHDRCODE, FACPERCENTAGE, INSURERCODE,
    RIREFCODE, OLDMANAGEBY, A_POLICYTYPE, PERIMUMCODE_BK, PORTALMEMBERID,LOGCODE,PORTALTYPE,SPONSORCODE)
    Values
    ((SELECT MAX(POLICYCODE) + 1 FROM IM_POLICY), L_POLICYID, L_POLICYNAME,
    SYSDATE,SYSDATE+364,L_GROUPCODE, 0, NULL, NULL, 1,
    0, NULL, NULL, 1, TO_DATE('03/13/2017 15:50:30', 'MM/DD/YYYY HH24:MI:SS'),
    100000000000000997, TO_DATE('03/13/2017 15:56:41', 'MM/DD/YYYY HH24:MI:SS'), 100000000000000997, 1, 1,
    TO_DATE('03/13/2017 15:50:30', 'MM/DD/YYYY HH24:MI:SS'), 100000000000000997,
    (SELECT MAX(SERIALNO) + 1 FROM IM_POLICY), NULL, 2,
    0, 2, 0, 2, 0,
    0, NULL, NULL, NULL, '',
    NULL, 0, 0, 1, NULL,
    0, NULL, 0, Decode(L_SOURCETYPE,5,NULL,L_SOURCECODE), Decode(L_SOURCETYPE,5,L_SOURCECODE,NULL),
    L_SPONSOR_ROW.ADMINISTRATEDBY, NULL, NULL, L_SOURCETYPE, NULL,
    NULL, 0, 0, NULL, 0,
    '65', 2, L_BRANCH, NULL, NULL,
    0, 11, NULL, 0, NULL,
    NULL, NULL, NULL, 0, 0,
    0, NULL, NULL, NULL, 0,
    NULL, NULL, NULL, 1, NULL,
    L_APPLICANTID,L_SPONSOR_ROW.SPONSOR_CODE,'PR',L_SPONSOR_ROW.SPONSOR_CODE);
    COMMIT;

    SELECT  POLICYCODE INTO L_POLICYCODE FROM IM_POLICY WHERE POLICYID = L_POLICYID;
    SELECT * INTO L_POLICY_ROW FROM IM_POLICY WHERE POLICYID = L_POLICYID;
    Insert into IM_POLICY_CATEGORYDTL
    (PCDCODE,
    POLICYCODE, CATEGORYCODE, ALTLIMIT, IPLIMIT, PLIMIT,
    PLANCODE, CALCULATEFINE, ISFRONTINGGROUP, FRONTINGSETTING, COMPANYCODE,
    CREATEDBY, LASTMODIFIEDBY, CREATEDON, LASTMODIFIEDON, LOCATIONCODE,
    SERIALNO, OPLIMIT, REMARKS, ACTIVE, GROUPCODE,
    MEMBERCODE, ROOMTYPE, EMGDETECTWINETWTYPE, EMGDETECTWINETWVALUE, EMGDETECTOONETWTYPE,
    EMGDETECTOONETWVALUE, TOTALPREMIUM, UBIPCODE, LIMITTYPE, LIMITS,
    CO_IN_TYPE, CO_IN_VALUE, OONDEDECTABLETYPE, OONDEDECTABLEVALUE, OONCO_IN_TYPE,
    OONCO_IN_VALUE, DEDECTABLETYPE, DEDECTABLEVALUE, REPORTTEMPLATECODE, ELEMENTTEMPLATECODE,
    HEALTHAPPROVELNO, ALERTCLAIMSTEAMREMARK)
    Values
    ((SELECT MAX(PCDCODE) + 1 FROM IM_POLICY_CATEGORYDTL), L_POLICYCODE, 100000000000000003, 0, 0,
    NULL, 100000000000000214, 1, 0, NULL,
    1, 100000000000000997, 100000000000000997, TO_DATE('03/13/2017 15:56:23', 'MM/DD/YYYY HH24:MI:SS'),
    TO_DATE('03/13/2017 15:56:23', 'MM/DD/YYYY HH24:MI:SS'),
    1, (SELECT MAX(SERIALNO) + 1 FROM IM_POLICY_CATEGORYDTL), 0, NULL, NULL,
    100000000000017085, NULL, 0, 2, 0,
    2, 0, 0, NULL, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, NULL,
    NULL, NULL, 0);
    COMMIT;

    --1 - IP,2 - OP,3 - Other,4 - Base
    IF L_SPONSOR_ROW.ADMINISTRATEDBY = 11 THEN
      L_RULES := INSERTGRPTPATREATY(L_INDIVIDUALPOLICYCODE,1,100000000000000210); --HANNOVER
      L_RULES := INSERTGRPTPATREATY(L_INDIVIDUALPOLICYCODE,2,100000000000000209); --FMC
      L_RULES := INSERTGRPTPATREATY(L_INDIVIDUALPOLICYCODE,3,100000000000000214); --OWN
      L_RULES := INSERTGRPTPATREATY(L_INDIVIDUALPOLICYCODE,5,100000000000000213); --DAYCARE
    ELSIF L_SPONSOR_ROW.ADMINISTRATEDBY = 3 THEN
      L_RULES := INSERTGRPTPATREATY(L_INDIVIDUALPOLICYCODE,3,100000000000000210); -- HANNOVER
      L_RULES := INSERTGRPTPATREATY(L_INDIVIDUALPOLICYCODE,4,100000000000000210);  -- HANNOVER
    ELSIF L_SPONSOR_ROW.ADMINISTRATEDBY = 1 THEN
       L_RULES := INSERTGRPTPATREATY(L_INDIVIDUALPOLICYCODE,3,100000000000000211); -- AWZ BLUE
       L_RULES := INSERTGRPTPATREATY(L_INDIVIDUALPOLICYCODE,4,100000000000000211);  -- AWZ BLUE
    END IF;


    Insert into IM_POLICY_COMMISSION
    (POLICY_COMM_CODE,
    POLICYCODE, COMISSION_TYPES, DEFAULTVALUE, CALC_METHOD, COMMISSION_VALUE,
    CREATEDIN, CREATEDON, CREATEDBY, LASTMODIFIEDON, LASTMODIFIEDBY,
    LEGALENTITYCODE, CUSTOMERCODE, LOCATIONCODE, SERIALNO, COMPANYCODE,
    COMMISSIONTO, COMMISIONTONAME, GENERALCOMMBILLINGCODE)
    Values
    ((SELECT MAX(POLICY_COMM_CODE) + 1 FROM IM_POLICY_COMMISSION), L_POLICYCODE, 1, Decode(L_SOURCETYPE,3,0,5), 1,
    Decode(L_SOURCETYPE,3,0,5), 1, TO_DATE('03/13/2017 15:50:30', 'MM/DD/YYYY HH24:MI:SS'), 100000000000000997, TO_DATE('03/13/2017 15:50:30', 'MM/DD/YYYY HH24:MI:SS'),
    100000000000000997, 100000000000000001, 100000000000000001, 1, (SELECT MAX(SERIALNO) + 1 FROM  IM_POLICY_COMMISSION),
    1, L_SOURCENAME,L_SOURCECODE, NULL);
    COMMIT;
    IF L_SPONSOR_ROW.ADMINISTRATEDBY <>  3 THEN
      IF L_SPONSOR_ROW.ADMINISTRATEDBY = 11 THEN
        L_OTHERBILLINGCODE :=  100000000000000090;
        L_OTHERBILLINGNAME := 'FMC TPA FEE AND CLAIMS FEE';
      ELSIF L_SPONSOR_ROW.ADMINISTRATEDBY = 1 THEN
        L_OTHERBILLINGCODE :=  100000000000000027;
        L_OTHERBILLINGNAME := 'NEXT CARE PREMIUM AND COM ACCOUNT';
      END IF;
      Insert into IM_POLICY_COMMISSION
      (POLICY_COMM_CODE,
      POLICYCODE, COMISSION_TYPES, DEFAULTVALUE, CALC_METHOD, COMMISSION_VALUE,
      CREATEDIN, CREATEDON, CREATEDBY, LASTMODIFIEDON, LASTMODIFIEDBY,
      LEGALENTITYCODE, CUSTOMERCODE, LOCATIONCODE, SERIALNO, COMPANYCODE,
      COMMISSIONTO, COMMISIONTONAME, GENERALCOMMBILLINGCODE)
      Values
      ((SELECT MAX(POLICY_COMM_CODE) + 1 FROM IM_POLICY_COMMISSION), L_POLICYCODE, 2,5, 1,
      5, 1, TO_DATE('03/13/2017 15:50:30', 'MM/DD/YYYY HH24:MI:SS'), 100000000000000997, TO_DATE('03/13/2017 15:50:30', 'MM/DD/YYYY HH24:MI:SS'),
      100000000000000997, 100000000000000001, 100000000000000001, 1, (SELECT MAX(SERIALNO) + 1 FROM  IM_POLICY_COMMISSION),
      1, NULL,L_OTHERBILLINGNAME, L_OTHERBILLINGCODE);
      COMMIT;
    END IF;

    UPDATE IM_POLICY SET AUTHORIZEDSTATUS = 1,POSTINGDONE = 1 WHERE  POLICYCODE = L_POLICYCODE;
    COMMIT;

  ELSE
    SELECT * INTO L_POLICY_ROW FROM IM_POLICY WHERE  LOGCODE = L_SPONSOR_ROW.SPONSOR_CODE AND PORTALTYPE='PR';
  END IF;

END IF;
IF L_SPONSOR_ROW.POLICYTYPE = 1 THEN
L_MEMPOLICYCODE := L_POLICY_ROW.POLICYCODE;
ELSE
L_MEMPOLICYCODE := L_IPPOLICY_ROW.INDIVIDUALPOLICYCODE;
END IF;
L_RULES := NGI_PR_CREATE_MEMBER_ORAFNC(L_SPONSOR_ROW.POLICYTYPE,L_MEMPOLICYCODE,P_PAYMENTCODE);
IF L_RULES = 'S' THEN
  IF L_SPONSOR_ROW.POLICYTYPE = 1 THEN
      FN_UWPOLADDMEMBERPOLICY(L_POLICY_ROW.POLICYCODE);
  ELSE
      FN_UWINDPOLADDMEMBERPOLICY(L_IPPOLICY_ROW.INDIVIDUALPOLICYCODE);
  END IF;
  IF L_SPONSOR_ROW.POLICYTYPE = 1 THEN
    UPDATE IM_PR_USERS SET GROUP_CODE = L_POLICY_ROW.GROUPCODE WHERE GROUP_CODE IS NULL AND SPONSOR_CODE = L_SPONSOR_ROW.SPONSOR_CODE;
    COMMIT;
  ELSE
    SELECT Max(MEMBER_CODE) INTO L_MEMCODE FROM IM_MEMBERS WHERE POLICYCODE = L_IPPOLICY_ROW.INDIVIDUALPOLICYCODE AND POLICYTYPE = 2;
    IF L_POLICYCOUNT = 0 THEN
      UPDATE  IM_INDIVIDUALPOLICY SET MEMBERCODE = L_MEMCODE WHERE INDIVIDUALPOLICYCODE = L_IPPOLICY_ROW.INDIVIDUALPOLICYCODE;
      COMMIT;
      UPDATE IM_PR_USERS SET MEMBERCODE = L_MEMCODE WHERE MEMBERCODE IS NULL AND SPONSOR_CODE = L_SPONSOR_ROW.SPONSOR_CODE;
      COMMIT;
    END IF;
  END IF;
  SELECT MAX(FINANCENO)+1 INTO L_FINANCENO FROM IM_POLICYFINANCEPOSTING;
  SELECT MAX(POLICYFINANCEPOSTINGCODE) + 1 INTO L_PRIMKEY FROM IM_POLICYFINANCEPOSTING;
  SELECT MAX(SERIALNO) + 1 INTO L_SNO FROM IM_POLICYFINANCEPOSTING;
  INSERT INTO IM_POLICYFINANCEPOSTING
  (ISTEST,POLICYFINANCEPOSTINGCODE,
  REFNO, REFDATE, POLICYTYPECODE, POLICYCODE, INDIVIDUALPOLICYCODE,
  CREATEDIN, CREATEDON, CREATEDBY, LASTMODIFIEDON, LASTMODIFIEDBY,
  COMPANYCODE, LOCATIONCODE, DEACTIVATEDON, DEACTIVATEDBY, SERIALNO,
  AUTHORIZEDSTATUS, FINANCEPREFIX, FINANCENO, FINANCESUFFIX, FINANCEFULLNO,
  BILLINGTYPE, BILLINGTYPENAME, REVERSEENDORSEMENTCODE, PRVERSEPOSTINGDONE, REVERSEFINACEDONE,
  BRANCHCODE, LOADAFTERSAVE, NOOFINSTALLMENT, ADDPREMIUMTOTAL, DELETEPREMIUMTOTAL,
  TOTAL, REVERSE_JV, OWNERCODE, FMCPRODHDRCODE, NEXTCAREPRODHDRCODE,
  PRODUCTIONBATCHCODE, PRODUCTIONSOURCE)
  VALUES
  (1,L_PRIMKEY, NULL,
  SYSDATE,L_SPONSOR_ROW.POLICYTYPE,Decode(L_SPONSOR_ROW.POLICYTYPE,1,L_POLICY_ROW.POLICYCODE,NULL),
  Decode(L_SPONSOR_ROW.POLICYTYPE,2,L_IPPOLICY_ROW.INDIVIDUALPOLICYCODE,NULL),1,SYSDATE,P_CREATEDBY,
  SYSDATE,P_CREATEDBY, 1, 1, NULL, NULL,
  L_SNO,0,NULL,L_FINANCENO, NULL,
  '-'||L_FINANCENO||'', 0, Decode(L_SPONSOR_ROW.POLICYTYPE,1,'GROUP','INDIVIDUAL'), NULL, NULL,
  NULL,L_BRANCH,0,1,0,
  0, 0, NULL, NULL, NULL,
  NULL,NULL,NULL);
  COMMIT;

  INSERT INTO IM_POLICYFINANCE_INSTALLMENT
  (POLICYFINANCEPOSTINGCODE,
  POLICYFINANCEINSTALLMENTCODE, PERCENTAGE, CREATEDIN, CREATEDON, CREATEDBY,
  LASTMODIFIEDON, LASTMODIFIEDBY, COMPANYCODE, LOCATIONCODE, SERIALNO,
  AMOUNT, INSTALLMENTDATE, INSTALLMENTNO, CALC_METHOD)
  VALUES
  (L_PRIMKEY,
  (SELECT MAX(POLICYFINANCEINSTALLMENTCODE) + 1 FROM IM_POLICYFINANCE_INSTALLMENT),100,NULL,
  SYSDATE,P_CREATEDBY,SYSDATE,P_CREATEDBY,1,1,
  (SELECT MAX(SERIALNO) + 1 FROM IM_POLICYFINANCE_INSTALLMENT),0,SYSDATE,1,1);
  COMMIT;
  IM_UW_ENDORSEMENT_FN(L_PRIMKEY);
  SELECT Sum(Abs(ADDPREMIUM)),Sum(Abs(REFUNDPREMIUM)) INTO L_ADDPREMIUM,L_REFUNDPREMIUM
  FROM IM_POLICYFINANCEPOSTINGDTL WHERE POLICYFINANCEPOSTINGCODE = L_PRIMKEY;
  UPDATE IM_POLICYFINANCEPOSTING SET ADDPREMIUMTOTAL = L_ADDPREMIUM,DELETEPREMIUMTOTAL = L_REFUNDPREMIUM,
  TOTAL = L_ADDPREMIUM-L_REFUNDPREMIUM  WHERE POLICYFINANCEPOSTINGCODE = L_PRIMKEY;
  COMMIT;
  UPDATE IM_POLICYFINANCE_INSTALLMENT SET AMOUNT = L_ADDPREMIUM-L_REFUNDPREMIUM  WHERE POLICYFINANCEPOSTINGCODE = L_PRIMKEY;
  COMMIT;
  V_RESULT:=SF_POSTUWEND_FNC(L_PRIMKEY,P_CREATEDBY);

  UPDATE IM_PR_PAYMENT_HDR SET POLICYFINANCEPOSTINGCODE = L_PRIMKEY WHERE PAYMENTCODE=P_PAYMENTCODE;
  COMMIT;

END IF;
RETURN 'OK';
EXCEPTION WHEN OTHERS THEN
L_ERROR := SQLERRM;
P_RESULT := 2;
RETURN L_ERROR;
END;
/

