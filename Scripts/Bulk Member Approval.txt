INSERT INTO IM_MEMBERS
(GROUP_CODE,     MEMBER_CODE, MEMBER_ID, MEMBER_TYPE, FIRST_NAME, MIDDLENAME, LAST_NAME, ARABIC_FIRST_NAME,
DATE_OF_BIRTH, GENDER, DESIGNATION, NATIONALITY, DEPARTMENT,
EMIRATES_ID, MOBILE_NUMBER, PHONE_NUMBER, COVERED_FROM_DATE, EFFECTIVE_START_DATE,
EFFECTIVE_END_DATE, PARENT_ID, LEGALENTITYCODE, CUSTOMERCODE, LOCATIONCODE,
COMPANYCODE, SERIALNO, CATEGORY_CODE, RELATIONCODE,RELATION, MARITAL_STATUS,
USERCODE, COVERED_END_DATE, CARDID,  ADDRESS,
EMPLOYEENO, EMIRATECODE,  PARENTGROUPCODE, INCEPTION_DATE,
ISEXISTINGMEMBER, EXISTING_INSURER, DATE_OF_ENTRY, COCEXPIRY, OCCUPATION,
EMAIL_ID, PASSPORT_NO, HEIGHT, WEIGHT, STAFF_ID,
DISCOUNT_PCT, LOADING_PCT, LOCATION, STATUS, USERNAME,
PASSWORD, MEMBERPOLICYCODE, POLICYCODE, POLICYTYPE,POLICYMEMBERID,POLICYADDREFCODE,POLICY_MEM_CODE,APOLICYID,APOLICYNAME,MEMBERSINCE,ENTRYTYPE,WAIVEAMOUNT,HAADFINE,NOOFDAYS,
WORKLOCATION, RESIDENTLOCATION, ISCOMMISSION, SALARYBAND, UIDNUMBER, ISPREEXISTING, ENTITYTYPE, ENTITYID
)

SELECT MPOL.GROUPCODE GROUP_CODE, 100000000000539249+ROWNUM MEMBER_CODE,AM.MEMBERID MEMBER_ID, 1 AS MEMBER_TYPE,
AM.MEMBERNAME AS FIRST_NAME,AM.SECONDNAME AS MIDDLENAME, AM.FAMILYNAME AS LAST_NAME,AM.MEMBERNAME AS ARABIC_FIRST_NAME,AM.DATE_OF_BIRTH,AM.MEMBER_GENDER AS GENDER,--NULL AS RELATION,
NULL AS DESIGNATION,NATIONALITY AS NATIONALITY,NULL AS DEPARTMENT,AM.EMIRATES_ID,AM.MOBILE_NO AS MOBILE_NUMBER,AM.PHONE_NO AS PHONE_NUMBER,
MPOL.STARTDATE COVERED_FROM_DATE,
MPOL.STARTDATE EFFECTIVE_START_DATE,NULL AS EFFECTIVE_END_DATE,NULL AS PARENT_ID,AM.LEGALENTITYCODE AS LEGALENTITYCODE,AM.CUSTOMERCODE,AM.LOCATIONCODE,
AM.COMPANYCODE,539249+ROWNUM SERIALNO,AM.MEMBER_CATEGORY AS CATEGORY_CODE,AM.MEMBER_RELATION AS RELATIONCODE,AM.MEMBER_RELATION AS RELATION,AM.MARITAL_STATUS AS MARITAL_STATUS,--NULL AS CARDNO,
NULL AS USERCODE,MPOL.ENDDATE COVERED_END_DATE,
NULL AS CARDID,AM.ADDRESS1 AS ADDRESS,NULL AS EMPLOYEENO,NULL AS EMIRATECODE,
AM.PARENTGROUPCODE,MPOL.STARTDATE INCEPTION_DATE,AM.ISEXISTINGMEMBER,AM.EXISTING_INSURER,AM.DATE_OF_ENTRY,AM.COCEXPIRY,
AM.OCCUPATION,AM.EMAIL_ID,AM.PASSPORT_NO,HEIGHT,WEIGHT,STAFF_ID,DISCOUNT_PCT,LOADING_PCT,LOCATION,0 STATUS,NULL AS USERNAME,NULL AS PASSWORD,
NULL AS MEMBERPOLICYCODE,MPOL.POLICYCODE POLICYCODE,1 POLICYTYPE,AM.MEMBERID POLICYMEMBERID,100000000000024473 POLICYADDREFCODE,AM.POLICY_MEM_CODE,
MPOL.POLICYID,MPOL.POLICYNAME ,AM.MEMBERSINCE,AM.ENTRYTYPE,AM.WAIVEAMOUNT,AM.HAADFINE,AM.NOOFDAYS,
AM.WORKLOCATION, AM.RESIDENTLOCATION, AM.ISCOMMISSION, AM.SALARYBAND, AM.UIDNUMBER, AM.ISPREEXISTING, AM.ENTITYTYPE, AM.ENTITYID
FROM IM_POLICY MPOL
--JOIN IM_POLICY POL ON POL.POLICYCODE=MPOL.POLICYCODE
JOIN IM_POLICY_MEMBERS  AM ON AM.POLICYCODE=MPOL.POLICYCODE
WHERE AM.PARENTID IS NULL AND  MPOL.POLICYCODE=100000000000024473 AND AM.MEMBERCODE IS NULL;



BEGIN
FOR HDR IN(SELECT * FROM IM_MEMBERS WHERE POLICYCODE=100000000000024473 ) LOOP

UPDATE IM_POLICY_MEMBERS  SET MEMBERCODE=HDR.MEMBER_CODE WHERE 
POLICY_MEM_CODE=HDR.POLICY_MEM_CODE AND MEMBERCODE IS NULL AND POLICYCODE=100000000000024473;
COMMIT;
END LOOP;
END;


UPDATE IM_MEMBERS SET POLICYADDREFCODE = 100000000000024473, 
(POLICYMEMBERID,CATEGORY_CODE,MEMBER_ID) =
(SELECT NVL(MAX(AM.MEMBERID),IM_MEMBERS.POLICYMEMBERID),NVL(MAX(AM.MEMBER_CATEGORY),IM_MEMBERS.CATEGORY_CODE),
NVL(MAX(AM.MEMBERID),IM_MEMBERS.MEMBER_ID) FROM IM_POLICY_MEMBERS  AM WHERE AM.POLICYCODE=100000000000024473 
AND  AM.MEMBERCODE=IM_MEMBERS.MEMBER_CODE)  WHERE  MEMBER_CODE IN 
(SELECT MEMBERCODE FROM IM_POLICY_MEMBERS  AM WHERE AM.POLICYCODE=100000000000024473);
       
                                                                    
DECLARE L_MEMBERPOLICYCODE NUMBER;L_SERIALNO NUMBER;
BEGIN
SELECT Max(MEMBERPOLICYCODE)+1 INTO L_MEMBERPOLICYCODE FROM IM_MEMBERPOLICY;
SELECT Max(SERIALNO)+1 INTO L_SERIALNO FROM IM_MEMBERPOLICY;
INSERT INTO IM_MEMBERPOLICY
SELECT L_MEMBERPOLICYCODE+ROWNUM,H.MEMBER_CODE,H.POLICYCODE,H.COVERED_FROM_DATE,P.ENDDATE,P.STARTDATE,P.ENDDATE, 
1, 1, NULL, NULL,SYSDATE, 100000000000000002, NULL, 100000000000000002, 100000000000000001, 100000000000000001, 
L_SERIALNO+ROWNUM,H.CATEGORY_CODE,SYSDATE,0, 1, 0, 0, 
NULL, NULL,H.DATE_OF_BIRTH, H.GENDER, H.RELATION, NULL, H.MARITAL_STATUS, H.MEMBER_ID, H.FIRST_NAME||' '||H.MIDDLENAME||' '||H.LAST_NAME, 
H.GROUP_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
NULL, NULL, H.FIRST_NAME, H.LAST_NAME,H.FIRST_NAME,H.NATIONALITY, H.EMIRATES_ID, H.MOBILE_NUMBER, 
H.PHONE_NUMBER,NULL, H.RELATION, H.MARITAL_STATUS, H.CARDNO, H.EMAILID, NULL, NULL, NULL, NULL, NULL, 
H.PHONE_NUMBER, H.MOBILE_NUMBER, H.EMAILID, H.PASSPORT_NO, NULL, NULL, H.STAFF_ID, '1',H.MEMBERSINCE, H.APOLICYID,H.APOLICYNAME, 
H.CARDNO, NULL, NULL, NULL, H.WORKLOCATION, H.RESIDENTLOCATION, H.ISCOMMISSION, H.SALARYBAND, H.UIDNUMBER, NULL, 
NULL, NULL, NULL,NULL, NULL, NULL, 0         
FROM IM_MEMBERS H
JOIN IM_POLICY P ON P.POLICYCODE = H.POLICYCODE
WHERE H.POLICYTYPE=1 AND H.POLICYCODE = 100000000000024473;
COMMIT;
END;

DECLARE AMEMBERPOLICYDETAILPKEY NUMBER;AMEMBERPOLICYDETAILCOUNTER NUMBER;      
BEGIN  
SELECT NVL(MAX(SERIALNO),0)+1,NVL(MAX(MEMBERPOLICYPREMIUMDTLCODE),100000000000000000)+1 INTO 
AMEMBERPOLICYDETAILCOUNTER,AMEMBERPOLICYDETAILPKEY FROM IM_MEMBERPOLICYPREMIUMDTL;   
INSERT INTO IM_MEMBERPOLICYPREMIUMDTL
(MEMBERPOLICYPREMIUMDTLCODE, MEMBERPOLICYCODE, PREMIUM_TYPES, DEFAULTVALUE, CALC_METHOD, PREMIUM_VALUE, LOCATIONCODE, 
SERIALNO, COMPANYCODE, DESCRIPTION, BENEFITCODE)
SELECT AMEMBERPOLICYDETAILPKEY+ROWNUM MEMBERPOLICYPREMIUMDTLCODE,  
MEMPOLICY.MEMBERPOLICYCODE MEMBERPOLICYCODE, PREMIUM_TYPES, TO_NUMBER(DEFAULTVALUE) DEFAULTVALUE,
CALC_METHOD, PREMIUM_VALUE,1 LOCATIONCODE,AMEMBERPOLICYDETAILCOUNTER+ROWNUM SERIALNO,1 COMPANYCODE, 
DESCRIPTION, BENEFITCODE
FROM IM_MEMBERPOLICY MEMPOLICY
JOIN IM_POLICY MPOL ON MPOL.POLICYCODE = MEMPOLICY.POLICYCODE AND MEMPOLICY.TYPEE = 1
JOIN IM_POLICY_MEMBERS  AM ON AM.POLICYCODE=MEMPOLICY.POLICYCODE 
AND MPOL.POLICYCODE = MEMPOLICY.POLICYCODE AND AM.MEMBERCODE=MEMPOLICY.MEMBERCODE --AND  AM.POLICYCODE IN (SELECT POLICYCODE FROM IM_POLICY WHERE BILLINGNO IN(206))
JOIN (
SELECT POLICY_MEM_CODE,PREMIUM_TYPES, DEFAULTVALUE,CALC_METHOD, PREMIUM_VALUE,DESCRIPTION, BENEFITCODE  FROM IM_POLICY_PREMIUM --WHERE IM_POLICY_PREMIUM.POLICY_MEM_CODE=AM.POLICY_MEM_CODE
UNION ALL
SELECT  POLICY_MEM_CODE,PREMIUM_TYPES, DEFAULTVALUE,CALC_METHOD, PREMIUM_VALUE,DESCRIPTION, BENEFITCODE FROM IM_POLICY_ADDTIONALPREMIUM --WHERE M_POLICY_ADDTIONALPREMIUM.POLICY_MEM_CODE=AM.POLICY_MEM_CODE
)  MEMPOL ON MEMPOL.POLICY_MEM_CODE=AM.POLICY_MEM_CODE
WHERE   MPOL.POLICYCODE = 100000000000024473;
COMMIT;   
END;
   