DECLARE L_PRICE NUMBER(19,2);
BEGIN
FOR HDR IN(SELECT D.*,H.ENCOUNTER_START_DATE FROM IM_CLAIM_PROCESS_HEADER H,IM_CLAIM_PROCESS_DETAIL D 
WHERE H.CLAIM_CODE = D.CLAIM_CODE AND Nvl(D.TYPE,0)= 0 AND H.PROVIDER_CODE IN
(SELECT PROVIDERCODE FROM IM_PROVIDERS WHERE PROVIDERNAME LIKE '%MEDICLINIC%')
AND Nvl(AUTHORIZEDSTATUS,0) = 0  AND PRICE = -1) LOOP
SELECT Max(NETVALUE) INTO L_PRICE FROM IM_PROVIDER_TARIFF_DETAILS
WHERE TARIFFCODE IN(SELECT TARIFFCODE FROM IM_PROVIDER_TARIFF WHERE PROVIDERCODE = HDR.PROVIDER_CODE
AND VERSIONDETAILCODE IN(SELECT DETAILCODE FROM IM_VERSION_DETALIS WHERE CODE IN
(SELECT CODE FROM IM_VERSION_DETALIS WHERE DETAILCODE = HDR.VERSIONDETAILCODE)))
AND To_Date(HDR.ENCOUNTER_START_DATE,'DD/MM/RRRR') BETWEEN To_Date(EFFECTIVEFROM,'DD/MM/RRRR') AND 
To_Date(EFFECTIVETO,'DD/MM/RRRR');
IF L_PRICE = 0 OR L_PRICE IS NULL THEN
SELECT Max(NETVALUE) INTO L_PRICE FROM IM_PROVIDER_TARIFF_DETAILS
WHERE TARIFFCODE IN(SELECT TARIFFCODE FROM IM_PROVIDER_TARIFF WHERE PROVIDERCODE = HDR.PROVIDER_CODE
AND STANDARDCODE IN(SELECT DETAILCODE FROM IM_VERSION_DETALIS WHERE CODE IN
(SELECT CODE FROM IM_VERSION_DETALIS WHERE DETAILCODE = HDR.VERSIONDETAILCODE)))
AND To_Date(HDR.ENCOUNTER_START_DATE,'DD/MM/RRRR') BETWEEN To_Date(EFFECTIVEFROM,'DD/MM/RRRR') AND 
To_Date(EFFECTIVETO,'DD/MM/RRRR'); 
END IF;
UPDATE IM_CLAIM_PROCESS_DETAIL SET PRICE = L_PRICE,PROVIDERNETPRICE = L_PRICE,SYS_ACTIVITY_STATUS = NULL
WHERE ACTIVITY_DETAIL_CODE = HDR.ACTIVITY_DETAIL_CODE;
COMMIT;
END LOOP;
END;





  
SELECT IPTD.* FROM IM_PROVIDER_TARIFF IPT,IM_PROVIDER_TARIFF_DETAILS IPTD
WHERE PROVIDERCODE=1000000000000000053 AND IPT.TARIFFCODE = IPTD.TARIFFCODE
ORDER BY  IPTD.EFFECTIVETO DESC
 



