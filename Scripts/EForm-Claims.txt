SELECT CLAIMLINE,BENEFICARYCARDNUMBER,CLAIMNUMBER,CLAIMTYPE,COUNTRYNAME,ISEMERGENCY,CLAIMSTATUS,PROVIDERTYPE,PROVIDERID,TRANSACTION_DATE,
DISCHARGEDATE,REPORTEDDATE,PAYMENTDATE,CLAIMEDAMOUNT,APPROVEDAMOUNT,BENEFICARYSHARE,
Decode(ISREVERSEDFORDEBIT,0,DECLINEDAMOUNT,1,0)DECLINEDAMOUNT,Decode(ISREVERSEDFORDEBIT,0,NETAMOUNT1,1,(DECLINEDAMOUNT*-1)) NETVALUE,
REVERSEREFDATE,INVOICENUMBER,DECLINEREASON,CLAIMSOURCE,PROCESSDATE,PROVIDERNAME,BENEFITTYPE,ACTIVITYTYPE,ICDCODES,ICDDESCRIPTION,
MAINBRANCH,SUBBRANCH,FURTHERBRANCH,PROCEDURETYPE,LICENSEAUTHORITY,PROFESSIONALID,PROFESSIONALTYPE,
PROFESSIONALSPECIALITY,PROFESSIONALNAME,UWYEAR,MANAGEDBY,NETWORKTYPE FROM(
SELECT HDR1.*,DECODE(MEMOTYPE,1,(NETAMOUNT*-1),NETAMOUNT) NETAMOUNT1 FROM(
SELECT HDR.*,GROSSAMOUNT - GROSSAMOUNT / 100 * DISCOUNTPERCENT NETAMOUNT FROM (
SELECT MPOL.ACARDID BENEFICARYCARDNUMBER,HDR.ACR_FORM_NO CLAIMNUMBER,ROWNUM CLAIMLINE,
Decode(HDR.REQUEST_TYPE,1,'EClaim',2,'Paper Claim',3,'Reimbursement Claim',4,'TPA Claim') CLAIMTYPE,
CON.COUNTRYNAME,'N' ISEMERGENCY,Decode(HDR.CLAIM_STATUS,2,'Processed','Pending') CLAIMSTATUS,
GEN.CONSTANTNAME PROVIDERTYPE,PRO.PROVIDERID,To_Char(HDR.ENCOUNTER_START_DATE,'DD/MM/RRRR') TRANSACTION_DATE,
To_Char(Nvl(HDR.ENCOUNTER_END_DATE,HDR.ENCOUNTER_START_DATE),'DD/MM/RRRR') DISCHARGEDATE,
To_Char(HDR.TRANSACTIONDATE,'DD/MM/RRRR') REPORTEDDATE,TO_CHAR (HDR.PAYMENTREFDATE, 'DD/MM/RRRR') PAYMENTDATE,
HDR.REQUEST_AMOUNT CLAIMEDAMOUNT,
((ROUND (HDR.APPROVED_AMOUNT, 2)+ (SELECT NVL (SUM (NVL (DENIEDAMOUNT, 0)), 0) DENIEDAMOUNT
FROM IM_DECLINEAMOUNT_VW VW WHERE VW.CLAIM_CODE = HDR.CLAIM_CODE AND
HDR.CLAIM_CODE NOT IN(SELECT CLAIM_CODE FROM REJDEC)AND REQUEST_TYPE IN (1, 2))) +
Nvl(HDR.CO_INS_VALUE,0) + Nvl(HDR.DEDUCTABLEVALUE,0)) APPROVEDAMOUNT,
(Nvl(HDR.CO_INS_VALUE,0) + Nvl(HDR.DEDUCTABLEVALUE,0)) BENEFICARYSHARE,
NVL ( (SELECT SUM (DENIEDAMOUNT)FROM IM_RECOVERYAMOUNT_VW DEC
WHERE DEC.CLAIM_CODE = HDR.CLAIM_CODE),0) DECLINEDAMOUNT,
(ROUND (HDR.APPROVED_AMOUNT, 2)+ (SELECT NVL (SUM (NVL (DENIEDAMOUNT, 0)), 0) DENIEDAMOUNT
FROM IM_DECLINEAMOUNT_VW VW WHERE VW.CLAIM_CODE = HDR.CLAIM_CODE AND
 HDR.CLAIM_CODE NOT IN(SELECT CLAIM_CODE FROM REJDEC)AND REQUEST_TYPE IN (1, 2)))
GROSSAMOUNT,TO_CHAR (HDR.REVERSEREFDATE, 'DD/MM/RRRR') REVERSEREFDATE,
HDR.INVOICENUMBER,
(SELECT LISTAGG (IMVD.SHORTDESC, ',')WITHIN GROUP (ORDER BY IMVD.SHORTDESC)
FROM IM_CLAIM_PROCESS_DETAIL DTL
JOIN IM_VERSION_DETALIS IMVD ON IMVD.DETAILCODE = DTL.DENIAL_REASON
WHERE  HDR.CLAIM_CODE = DTL.CLAIM_CODE AND ROWNUM < 21
GROUP BY DTL.CLAIM_CODE)DECLINEREASON,GEN1.CONSTANTNAME CLAIMSOURCE,
Decode(HDR.CLAIM_STATUS,2,To_Char(HDR.LASTMODIFIEDON,'DD/MM/RRRR'),'') PROCESSDATE,
PRO.PROVIDERNAME,(SELECT LISTAGG (IBC.BENEFIT_ID, ',') WITHIN GROUP (ORDER BY IBC.BENEFIT_ID)
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_BENEFIT_CODES IBC ON IBC.BENEFIT_CODE = DTL.BENEFIT_CODE
WHERE DTL.CLAIM_CODE = HDR.CLAIM_CODE AND ROWNUM < 21
GROUP BY DTL.CLAIM_CODE) BENEFITTYPE,
(  SELECT LISTAGG (IMVD.SHORTDESC, ',') WITHIN GROUP (ORDER BY IMVD.SHORTDESC)
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_ACTIVITY_TYPES ACTTYP ON ACTTYP.TYPECODE = DTL.ACTIVITY_CODE
JOIN IM_VERSION_DETALIS IMVD  ON IMVD.DETAILCODE = DTL.VERSIONDETAILCODE
WHERE ACTTYP.VALUE <> -1 AND ROWNUM < 21 AND DTL.CLAIM_CODE = HDR.CLAIM_CODE
GROUP BY DTL.CLAIM_CODE) ACTIVITYTYPE,
(SELECT LISTAGG (IMVD.CODE, ',') WITHIN GROUP (ORDER BY IMVD.CODE)
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_ACTIVITY_TYPES ACTTYP ON ACTTYP.TYPECODE = DTL.ACTIVITY_CODE
JOIN IM_VERSION_DETALIS IMVD  ON IMVD.DETAILCODE = DTL.VERSIONDETAILCODE
WHERE ACTTYP.VALUE = -1 AND ROWNUM < 21 AND DTL.CLAIM_CODE = HDR.CLAIM_CODE
GROUP BY DTL.CLAIM_CODE) ICDCODES,
(SELECT LISTAGG (IMVD.SHORTDESC, ',') WITHIN GROUP (ORDER BY IMVD.SHORTDESC)
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_ACTIVITY_TYPES ACTTYP ON ACTTYP.TYPECODE = DTL.ACTIVITY_CODE
JOIN IM_VERSION_DETALIS IMVD  ON IMVD.DETAILCODE = DTL.VERSIONDETAILCODE
WHERE ACTTYP.VALUE = -1 AND ROWNUM < 21 AND DTL.CLAIM_CODE = HDR.CLAIM_CODE
GROUP BY DTL.CLAIM_CODE) ICDDESCRIPTION,
SF_GETMAINBRANCH(HDR.MEMBERPOLICYCODE) MAINBRANCH,
SF_GETMAINBRANCH(HDR.MEMBERPOLICYCODE) SUBBRANCH,
SF_GETMAINBRANCH(HDR.MEMBERPOLICYCODE) FURTHERBRANCH,
(SELECT Trim(LISTAGG(To_Char(ACTTYP.TYPENAME), ',') WITHIN GROUP (ORDER BY ACTTYP.TYPENAME))
FROM IM_CLAIM_PROCESS_DETAIL DTL
LEFT JOIN IM_ACTIVITY_TYPES ACTTYP ON ACTTYP.TYPECODE = DTL.ACTIVITY_CODE
WHERE ACTTYP.VALUE <> -1 AND ROWNUM < 21 AND DTL.CLAIM_CODE = HDR.CLAIM_CODE
GROUP BY DTL.CLAIM_CODE) PROCEDURETYPE,Decode(HDR.SOURCEPROVIDER,1,'DHA',2,'HADD') LICENSEAUTHORITY,
SF_GETCLINICIANINFO(HDR.CDCODE,1) PROFESSIONALID,
SF_GETCLINICIANINFO(HDR.CDCODE,3) PROFESSIONALTYPE,
SF_GETCLINICIANINFO(HDR.CDCODE,2) PROFESSIONALSPECIALITY,
SF_GETCLINICIANINFO(HDR.CDCODE,4) PROFESSIONALNAME,NVL (HDR.DISCOUNTPERCENTAGE, 0) DISCOUNTPERCENT,DECODE (ISNEXTCARE,
1, 'In net',
(SELECT L_INNET
FROM TABLE (
SF_GETCLAIMSNWTYPE_FNC (
HDR.POLICYCODE,
HDR.CATEGORY_CODE,
HDR.PROVIDER_CODE,
1))))
NETWORKTYPE,NVL (GEN8.CONSTANTNAME, 'NGI') MANAGEDBY,NVL (POL.POLICYID, IPOL.POLICYID) POLICYID,HDR.MEMOTYPE,
Nvl(HDR.ISREVERSEDFORDEBIT,0) ISREVERSEDFORDEBIT,To_Char(Nvl(POL.STARTDATE,IPOL.STARTDATE),'RRRR') UWYEAR
FROM
(SELECT * FROM IM_CLAIM_PROCESS_HEADER WHERE TRANSACTIONDATE BETWEEN
To_Date('01/04/2016','DD/MM/RRRR') AND To_Date('30/04/2016','DD/MM/RRRR')) HDR
LEFT JOIN IM_MEMBERPOLICY MPOL ON MPOL.MEMBERPOLICYCODE = HDR.MEMBERPOLICYCODE
LEFT JOIN IM_PROVIDERS PRO ON PRO.PROVIDERCODE = HDR.PROVIDER_CODE
LEFT JOIN GENCONSTANT GEN ON GEN.CONSTANTVALUE = PRO.PROVIDERTYPE AND GEN.CATEGORY='PROVIDERTYPE' AND Upper(GEN.LANGUAGECODE) = 'EN-US'
LEFT JOIN GENCONSTANT GEN1 ON GEN1.CONSTANTVALUE = HDR.SOURCEPROVIDER AND GEN1.CATEGORY='PRIORSOURCEPROVIDER' AND Upper(GEN1.LANGUAGECODE) = 'EN-US'
LEFT JOIN GENCOUNTRY CON ON CON.COUNTRYCODE = PRO.COUNTRYCODE
LEFT JOIN IM_POLICY POL ON POL.POLICYCODE = NVL (MPOL.POLICYCODE, HDR.POLICYCODE) --AND MPOL.TYPEE = 1
LEFT JOIN IM_INDIVIDUALPOLICY IPOL ON IPOL.INDIVIDUALPOLICYCODE = NVL (MPOL.POLICYCODE, HDR.POLICYCODE)
LEFT JOIN GENCONSTANT GEN8 ON GEN8.CONSTANTVALUE = NVL (POL.OWNERCODE, IPOL.OWNERCODE) AND GEN8.CATEGORY = 'NGIQUOTATIONTYPE' AND UPPER (GEN8.LANGUAGECODE) = 'EN-US'
WHERE HDR.ACR_MEMBER_NO IS NULL AND CLAIM_CODE NOT IN (SELECT CLAIMCODE FROM IM_ENDPOSTCLAIMDTL WHERE ENDORESMENTCODE
IN (SELECT CLAIMREFCODE FROM JAN12011 WHERE REVERSEJVCODE =
100000000000007308))
)HDR)HDR1)
/

