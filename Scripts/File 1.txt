PROMPT CREATE OR REPLACE FUNCTION sf_finjvsindaccstatement
CREATE OR REPLACE FUNCTION sf_finjvsindaccstatement
(
ABANKACCOUNT VARCHAR2 DEFAULT 'ALL',
ASTARTDATE DATE DEFAULT SYSDATE-15,
AENDDATE DATE DEFAULT SYSDATE,
CHECKBOXOPTION NVARCHAR2 DEFAULT 'YY',
INCLUDEBALANCE NVARCHAR2 DEFAULT 'YY',
CURRENTUSER NUMBER DEFAULT 1,
ALANGUAGECODE NVARCHAR2 DEFAULT 'en-US',
 Acurrentcompany NVARCHAR2 DEFAULT '1'
)
RETURN FINJVFININDSTMTACCOUNTTABLE PIPELINED IS
TABLEDATA FINJVFININDSTMTACCOUNTTYPE := FINJVFININDSTMTACCOUNTTYPE(
NULL,NULL,NULL,NULL,
NULL,NULL,NULL,NULL
);
TYPE LCURTYPE IS REF CURSOR;
LCUR LCURTYPE;
BEGIN
IF INCLUDEBALANCE = 'YY' THEN
OPEN LCUR FOR
SELECT ACC_CODE,ACC_DESCRIPTION,DEBITTOTAL,CREDITTOTAL,
OPENINGBALANCE,(OPENINGBALANCE+BALANCE)BALANCE,ACCCODE,
'Y' ISERIALNO
FROM
(
SELECT DISTINCT
(SELECT NVL((SUM(A.DEBIT_AMOUNT)-SUM(A.CREDIT_AMOUNT)),0) OPENINGBALANCE
FROM GL_JE_LINES A, GL_JE_HEADERS B
WHERE A.JE_CODE=B.JE_CODE AND A.ACCOUNT_ID=DTL.ACCOUNT_ID AND TO_DATE(B.JE_DATE,'DD/MM/YYYY')=TO_DATE(ASTARTDATE,'DD/MM/YYYY')  AND

A.JE_LINE_CODE=DTL.JE_LINE_CODE) OPENINGBALANCE,
(SELECT NVL((SUM(A.DEBIT_AMOUNT)-SUM(A.CREDIT_AMOUNT)),0)BALANCE
FROM GL_JE_LINES A, GL_JE_HEADERS B
WHERE A.JE_CODE=B.JE_CODE AND A.ACCOUNT_ID=DTL.ACCOUNT_ID AND TO_DATE(B.JE_DATE,'DD/MM/YYYY') BETWEEN TO_DATE(ASTARTDATE,'DD/MM/YYYY') AND

TO_DATE(AENDDATE,'DD/MM/YYYY')) BALANCE,
ACCN.ACC_CODE,(ACC.ATTRIBUTE3 || '.'||ACCN.ACC_DESCRIPTION) ACC_DESCRIPTION,
(SELECT SUM(DEBIT_AMOUNT) FROM GL_JE_LINES A, GL_JE_HEADERS B WHERE A.JE_CODE=B.JE_CODE AND A.ACCOUNT_ID=DTL.ACCOUNT_ID AND TO_DATE

(B.JE_DATE,'DD/MM/YYYY') BETWEEN TO_DATE(ASTARTDATE,'DD/MM/YYYY') AND TO_DATE(AENDDATE,'DD/MM/YYYY') ) DEBITTOTAL,
(SELECT SUM(CREDIT_AMOUNT) FROM GL_JE_LINES A, GL_JE_HEADERS B WHERE A.JE_CODE=B.JE_CODE AND A.ACCOUNT_ID=DTL.ACCOUNT_ID AND TO_DATE

(B.JE_DATE,'DD/MM/YYYY') BETWEEN TO_DATE(ASTARTDATE,'DD/MM/YYYY') AND TO_DATE(AENDDATE,'DD/MM/YYYY')) CREDITTOTAL,
SUBSTR(ACCN.ACC_CODE,'0','1') ACCCODE
FROM GL_JE_HEADERS HD
JOIN GL_JE_LINES DTL ON HD.JE_CODE=DTL.JE_CODE
JOIN GL_CODE_COM_DETAILS ACC ON ACC.CODE_COM_ID=DTL.ACCOUNT_ID
 --  left join admcompany com on com.companycode=HD.COMPANYCODE
   left join admcustomer cust on cust.CUSTOMERCODE = com.CUSTOMERCODE
   JOIN GL_ACCOUNTS ACCN ON ACC.ATTRIBUTE4=ACCN.ACC_CODE  and ACCN.CUSTOMERCODE =cust.CUSTOMERCODE
     join admcompany com on com.companycode=Acurrentcompany  and com.CUSTOMERCODE=accn.CUSTOMERCODE and

com.LEGALENTITYCODE=accn.LEGALENTITYCODE
LEFT JOIN AR_MISC_RECEIPT_HEADERS RECH ON HD.JE_SOURCE=14 AND RECH.MISC_RECEIPT_CODE = HD.SOURCE_CODE
LEFT JOIN AP_MISC_PAYMENT_HEADERS PAYH ON HD.JE_SOURCE=23 AND PAYH.MISC_PAYMENT_CODE = HD.SOURCE_CODE
LEFT JOIN BMRECIVEBONDS ARIV ON HD.JE_SOURCE=27 AND ARIV.RB_CODE = HD.SOURCE_CODE
LEFT JOIN BMBENEFICENTS BEN ON BEN.BENEFICENT_CODE=ARIV.BENEFICENT_CODE
LEFT JOIN AP_MULTI_CHEQUE_PAYMENT APMCP ON HD.JE_SOURCE=28 AND APMCP.CHEQUE_PAYMENT_CODE = HD.SOURCE_CODE
LEFT JOIN SC_COLLECTIONS SCC ON HD.JE_SOURCE=29 AND SCC.COLLECTIONS_CODE = HD.SOURCE_CODE
LEFT JOIN PRO_COLLECTIONS PRC ON HD.JE_SOURCE=31 AND PRC.COLLECTIONS_CODE = HD.SOURCE_CODE
LEFT JOIN INTERNAL_PAYMENT INP ON HD.JE_SOURCE=0 AND INP.INTERNAL_PAY_CODE = HD.SOURCE_CODE
JOIN GENCONSTANT CON ON CON.CATEGORY = 'POSTINGSOURCETYPE' AND CON.CONSTANTVALUE=HD.JE_SOURCE AND UPPER(CON.LANGUAGECODE)=UPPER

(ALANGUAGECODE)
WHERE TO_DATE(HD.JE_DATE,'DD/MM/YYYY') BETWEEN TO_DATE(ASTARTDATE,'DD/MM/YYYY') AND TO_DATE(AENDDATE,'DD/MM/YYYY')
and HD.COMPANYCODE =Acurrentcompany
AND
(ABANKACCOUNT='ALL' or ACCN.ACCOUNT_CODE IN (SELECT ACCOUNT_CODE
FROM GL_ACCOUNTS START WITH ACCOUNT_CODE IN (SELECT * FROM TABLE (FN_GETPORTALCRITERIA(ABANKACCOUNT,'JVAccCode',Acurrentcompany,-1,-1,-1,-

1,1,ALANGUAGECODE)))
CONNECT BY PRIOR ACCOUNT_CODE=PARENT_CODE ))

) HED
ORDER BY HED.ACCCODE asc
;
LOOP
FETCH LCUR INTO
TABLEDATA.ACC_CODE,
TABLEDATA.ACC_DESCRIPTION,
TABLEDATA.DEBITTOTAL,
TABLEDATA.CREDITTOTAL,
TABLEDATA.OPENINGBALANCE,
TABLEDATA.BALANCE,
TABLEDATA.ACCCODE,
TABLEDATA.ISERIALNO;
EXIT WHEN LCUR%NOTFOUND;
PIPE ROW(TABLEDATA);
END LOOP;
CLOSE LCUR;
ELSE
OPEN LCUR FOR
SELECT ACC_CODE,ACC_DESCRIPTION,DEBITTOTAL,CREDITTOTAL,
OPENINGBALANCE,BALANCE,ACCCODE,
'Y' ISERIALNO
FROM
(
SELECT DISTINCT
(SELECT NVL((SUM(A.DEBIT_AMOUNT)-SUM(A.CREDIT_AMOUNT)),0) OPENINGBALANCE
FROM GL_JE_LINES A, GL_JE_HEADERS B
WHERE A.JE_CODE=B.JE_CODE AND A.ACCOUNT_ID=DTL.ACCOUNT_ID AND TO_DATE(B.JE_DATE,'DD/MM/YYYY')=TO_DATE(ASTARTDATE,'DD/MM/YYYY')  AND

A.JE_LINE_CODE=DTL.JE_LINE_CODE) OPENINGBALANCE,
(SELECT NVL((SUM(A.DEBIT_AMOUNT)-SUM(A.CREDIT_AMOUNT)),0)BALANCE
FROM GL_JE_LINES A, GL_JE_HEADERS B
WHERE A.JE_CODE=B.JE_CODE AND A.ACCOUNT_ID=DTL.ACCOUNT_ID AND TO_DATE(B.JE_DATE,'DD/MM/YYYY') BETWEEN TO_DATE(ASTARTDATE,'DD/MM/YYYY') AND

TO_DATE(AENDDATE,'DD/MM/YYYY') ) BALANCE,
ACCN.ACC_CODE,(ACC.ATTRIBUTE3 ||'.'||ACCN.ACC_DESCRIPTION) ACC_DESCRIPTION,
(SELECT SUM(DEBIT_AMOUNT) FROM GL_JE_LINES A, GL_JE_HEADERS B WHERE A.JE_CODE=B.JE_CODE AND A.ACCOUNT_ID=DTL.ACCOUNT_ID AND TO_DATE

(B.JE_DATE,'DD/MM/YYYY') BETWEEN TO_DATE(ASTARTDATE,'DD/MM/YYYY') AND TO_DATE(AENDDATE,'DD/MM/YYYY')) DEBITTOTAL,
(SELECT SUM(CREDIT_AMOUNT) FROM GL_JE_LINES A, GL_JE_HEADERS B WHERE A.JE_CODE=B.JE_CODE AND A.ACCOUNT_ID=DTL.ACCOUNT_ID AND TO_DATE

(B.JE_DATE,'DD/MM/YYYY') BETWEEN TO_DATE(ASTARTDATE,'DD/MM/YYYY') AND TO_DATE(AENDDATE,'DD/MM/YYYY')) CREDITTOTAL,
SUBSTR(ACCN.ACC_CODE,'0','1') ACCCODE
FROM GL_JE_HEADERS HD
JOIN GL_JE_LINES DTL ON HD.JE_CODE=DTL.JE_CODE
JOIN GL_CODE_COM_DETAILS ACC ON ACC.CODE_COM_ID=DTL.ACCOUNT_ID
 --  left join admcompany com on com.companycode=HD.COMPANYCODE
   left join admcustomer cust on cust.CUSTOMERCODE = com.CUSTOMERCODE
   JOIN GL_ACCOUNTS ACCN ON ACC.ATTRIBUTE4=ACCN.ACC_CODE   and ACCN.CUSTOMERCODE =cust.CUSTOMERCODE
       join admcompany com on com.companycode=Acurrentcompany  and com.CUSTOMERCODE=accn.CUSTOMERCODE and

com.LEGALENTITYCODE=accn.LEGALENTITYCODE
LEFT JOIN AR_MISC_RECEIPT_HEADERS RECH ON HD.JE_SOURCE=14 AND RECH.MISC_RECEIPT_CODE = HD.SOURCE_CODE
LEFT JOIN AP_MISC_PAYMENT_HEADERS PAYH ON HD.JE_SOURCE=23 AND PAYH.MISC_PAYMENT_CODE = HD.SOURCE_CODE
LEFT JOIN BMRECIVEBONDS ARIV ON HD.JE_SOURCE=27 AND ARIV.RB_CODE = HD.SOURCE_CODE
LEFT JOIN BMBENEFICENTS BEN ON BEN.BENEFICENT_CODE=ARIV.BENEFICENT_CODE
LEFT JOIN AP_MULTI_CHEQUE_PAYMENT APMCP ON HD.JE_SOURCE=28 AND APMCP.CHEQUE_PAYMENT_CODE = HD.SOURCE_CODE
LEFT JOIN SC_COLLECTIONS SCC ON HD.JE_SOURCE=29 AND SCC.COLLECTIONS_CODE = HD.SOURCE_CODE
LEFT JOIN PRO_COLLECTIONS PRC ON HD.JE_SOURCE=31 AND PRC.COLLECTIONS_CODE = HD.SOURCE_CODE
LEFT JOIN INTERNAL_PAYMENT INP ON HD.JE_SOURCE=0 AND INP.INTERNAL_PAY_CODE = HD.SOURCE_CODE
JOIN GENCONSTANT CON ON CON.CATEGORY = 'POSTINGSOURCETYPE' AND CON.CONSTANTVALUE=HD.JE_SOURCE AND UPPER(CON.LANGUAGECODE)=UPPER

(ALANGUAGECODE)
WHERE
 HD.COMPANYCODE =Acurrentcompany and
TO_DATE(HD.JE_DATE,'DD/MM/YYYY') BETWEEN TO_DATE(ASTARTDATE,'DD/MM/YYYY') AND TO_DATE(AENDDATE,'DD/MM/YYYY') AND
(ABANKACCOUNT='ALL' or ACCN.ACCOUNT_CODE IN (SELECT ACCOUNT_CODE FROM GL_ACCOUNTS START WITH ACCOUNT_CODE IN (SELECT * FROM TABLE

(FN_GETPORTALCRITERIA(ABANKACCOUNT,'JVAccCode',Acurrentcompany,-1,-1,-1,-1,1,ALANGUAGECODE)))
CONNECT BY PRIOR ACCOUNT_CODE=PARENT_CODE ))
) HED
ORDER BY HED.ACCCODE asc
;
LOOP
FETCH LCUR INTO
TABLEDATA.ACC_CODE,
TABLEDATA.ACC_DESCRIPTION,
TABLEDATA.DEBITTOTAL,
TABLEDATA.CREDITTOTAL,
TABLEDATA.OPENINGBALANCE,
TABLEDATA.BALANCE,
TABLEDATA.ACCCODE,
TABLEDATA.ISERIALNO;
EXIT WHEN LCUR%NOTFOUND;
PIPE ROW(TABLEDATA);
END LOOP;
CLOSE LCUR;
END IF;
END SF_FINJVSINDACCSTATEMENT;




/

